<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 è·¨å¹´éŠ | è¡Œç¨‹ + çµ±è¨ˆ + AI æƒé›· (æ™‚ä»£å»£å ´é¢¨æ ¼)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght=400;500;700;900&family=JetBrains+Mono:wght=500&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* 1. åŸºç¤è¨­å®šï¼šæ™‚ä»£å»£å ´è·¨å¹´å¤œé¢¨æ ¼ */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100vh;
            background-color: #000000; /* ç´”é»‘å¤œç©º */
            font-family: 'Noto Sans TC', sans-serif;
            color: #E2E8F0; 
            overflow-x: hidden;
            /* è·¨å¹´å½©å±‘èƒŒæ™¯æ•ˆæœï¼šé‡‘è‰²å’Œéœ“è™¹è—è‰²å°é» */
            background-image: 
                radial-gradient(circle at 15% 30%, rgba(255, 215, 0, 0.15) 2px, transparent 3px),
                radial-gradient(circle at 80% 90%, rgba(0, 255, 255, 0.1) 1px, transparent 2px),
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.05) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
            background-attachment: fixed;
        }
        
        /* ç§»é™¤é›ªèŠ±å®¹å™¨ (ä½†ä¿ç•™ ID ä»¥å… JS å ±éŒ¯) */
        #snow-container {
            display: none; 
        }

        /* 3. å…§å®¹å±¤ */
        #root {
            position: relative;
            z-index: 10;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 4. ç»ç’ƒæ“¬æ…‹ (æ”¹ç‚ºæ·±è—ç°) */
        .glass-panel {
            background: rgba(10, 10, 30, 0.85); /* æ¥è¿‘é»‘è‰²çš„æ·±è— */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        /* AI Guard å°ˆå±¬æ¨£å¼ (B) */
        .strategy-box {
            border-left: 3px solid #00FFFF; /* éœ“è™¹è— */
            background: rgba(0, 255, 255, 0.05);
        }

        /* Leaflet Dark Mode Filter */
        .leaflet-layer, .leaflet-control-zoom-in, .leaflet-control-zoom-out, .leaflet-control-attribution {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        
        /* Loading Animation */
        .typing-indicator span { animation: blink 1.4s infinite both; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }

        /* Countdown Style */
        .countdown-style {
            background: linear-gradient(135deg, #FFD700, #FFA500, #00FFFF);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 20px rgba(0, 255, 255, 0.5);
        }

        /* Markdown Styles for AI Tips */
        .markdown-content ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .markdown-content ol { list-style-type: decimal; padding-left: 1.2em; margin-bottom: 0.5em; }
        .markdown-content p { margin-bottom: 0.5em; }
        .markdown-content strong { color: #00FFFF; }
        .markdown-content a { color: #4ECDC4; text-decoration: underline; }
    </style>
</head>
<body>
    <div id="snow-container"></div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- Gemini API Helper ---
        const generateGeminiContent = async (prompt, imageBase64 = null, useSearch = false) => {
            const defaultKey = ""; 
            let storedKey = localStorage.getItem('gemini_api_key');
            let apiKey = storedKey ? storedKey.trim() : defaultKey.trim();
            
            if (!apiKey) throw new Error("NO_API_KEY");

            const model = 'gemini-2.5-flash-preview-09-2025';
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            
            const parts = [{ text: prompt }];
            if (imageBase64) {
                const base64Data = imageBase64.split(',')[1] || imageBase64;
                parts.push({
                    inlineData: {
                        mimeType: "image/jpeg",
                        data: base64Data
                    }
                });
            }

            const payload = { contents: [{ parts: parts }] };
            
            if (useSearch) {
                payload.tools = [{ "google_search": {} }];
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    if (response.status === 403 && errData.error?.message?.includes('leaked')) {
                        localStorage.removeItem('gemini_api_key'); 
                        throw new Error("API Key å·²å¤±æ•ˆ (Keyå¤–æ´©)ã€‚è«‹ç”³è«‹æ–° Keyã€‚");
                    }
                    if (response.status === 400 && errData.error?.message?.includes('API key not valid')) {
                        localStorage.removeItem('gemini_api_key');
                        throw new Error("API Key ç„¡æ•ˆã€‚è«‹æª¢æŸ¥è¨­å®šã€‚");
                    }
                     if (response.status === 400 && (errData.error?.message?.includes('tool') || errData.error?.message?.includes('google_search')) && !imageBase64) {
                         const fallbackResponse = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        const fallbackData = await fallbackResponse.json();
                        return fallbackData.candidates?.[0]?.content?.parts?.[0]?.text || "AI å›æ‡‰ç‚ºç©º";
                    }
                    if (response.status === 404) {
                         throw new Error(`æ¨¡å‹ ${model} æœªæ‰¾åˆ° (404)ã€‚è«‹æª¢æŸ¥ API Key æ¬Šé™ã€‚`);
                    }
                    throw new Error(errData.error?.message || `HTTP Error: ${response.status}`);
                }
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼ŒAI æš«æ™‚ç„¡æ³•å›æ‡‰ã€‚";
            } catch (error) {
                console.error("Gemini API Error:", error);
                throw error;
            }
        };

        // --- Icons ---
        const Icons = {
            Plane: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 12h5"/><path d="M13 12h3"/><path d="M19.74 7.33a2.3 2.3 0 0 1 2.93 2.93l-3.33 3.33a2.3 2.3 0 0 1-3.25 0l-7.34-7.34a2.3 2.3 0 0 1 0-3.25l3.33-3.33z"/><path d="M14.66 14.66 9 22H2l2.5-9"/><path d="M7 17l-5 5"/></svg>,
            Smile: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></svg>,
            List: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            LayoutGrid: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>,
            Calculator: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Clock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Wallet: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></svg>,
            MapPin: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            Ticket: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></svg>,
            ExternalLink: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>,
            Footprints: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 11 3.8 11 8c0 1.25-.38 2-1.28 2.55-.4.25-.72.82-.72 1.25V16a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 2 13 3.8 13 8c0 1.25.38 2 1.28 2.55.4.25.72.82.72 1.25V16a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2z"/></svg>,
            Car: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H7.7c-.7 0-1.3.3-1.8.7-.9.9-2.2 2.3-2.2 2.3S1 10.6 1 11.1c-.8.2-1.5 1-1.5 1.9v3c0 .6.4 1 1 1h2"/><path d="M2.5 17a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"/><path d="M16.5 17a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"/><path d="M12 9V6"/></svg>,
            Navigation: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>,
            Hotel: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2Z"/><polyline points="7 2 7 20"/><polyline points="17 2 17 20"/><line x1="2" x2="22" y1="12" y2="12"/><line x1="2" x2="22" y1="17" y2="17"/></svg>,
            Star: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Coffee: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M10 2v2"/><path d="M14 2v2"/><path d="M6 2v2"/><path d="M18 8a1 1 0 0 1 1 1v2a3 3 0 0 1-3 3h-2.95a1 1 0 0 0-.768.369l-.254.332a4 4 0 0 1-3.26 1.623 4 4 0 0 1-3.296-1.402l-.125-.153A1 1 0 0 0 4.35 14H4a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1h14z"/><path d="M18 14v1a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-1"/></svg>,
            ShoppingBag: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>,
            Fuel: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="3" x2="15" y1="22" y2="22"/><line x1="4" x2="14" y1="9" y2="9"/><path d="M14 22V4a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v18"/><path d="M14 13h2a2 2 0 0 1 2 2v2a2 2 0 0 0 2 2h0a2 2 0 0 0 2-2V9.83a2 2 0 0 0-.59-1.42L18 5"/></svg>,
            MoreHorizontal: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>,
            Sun: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            CloudSnow: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M8 15h.01"/><path d="M8 19h.01"/><path d="M12 17h.01"/><path d="M12 21h.01"/><path d="M16 15h.01"/><path d="M16 19h.01"/></svg>,
            CloudRain: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M16 14v6"/><path d="M8 14v6"/><path d="M12 16v6"/></svg>,
            Cloud: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.2-3.4-3.1-6-6.5-6-3.7 0-6.6 2.8-6.9 6.4h-.1C2.1 16.4 0 18.5 0 21c0 2.2 1.8 4 4 4h13.5c2.2 0 4-1.8 4-4"/></svg>,
            Edit3: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>,
            Sparkles: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>,
            MessageCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>,
            Send: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>,
            Bot: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>,
            Settings: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.51a2 2 0 0 1 1-1.72l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            ArrowDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 5v14"/><path d="m19 12-7 7-7-7"/></svg>,
            Map: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21 3 6"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>,
            Search: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Gift: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.9 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></svg>,
            Store: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/><path d="M2 7h20"/><path d="M22 7v3a2 2 0 0 1-2 2v0a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12v0a2 2 0 0 1-2-2V7"/></svg>,
            Utensils: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>,
            LocateFixed: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="2" x2="5" y1="12" y2="12"/><line x1="19" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="5"/><line x1="12" x2="12" y1="19" y2="22"/><circle cx="12" cy="12" r="7"/><circle cx="12" cy="12" r="3"/></svg>,
            Loader2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
            Check: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="20 6 9 17 4 12"/></svg>,
            Navigation2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="12 2 19 21 12 17 5 21 12 2"/></svg>,
            Camera: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            ShoppingBasket: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m5 11 4-7"/><path d="m19 11-4-7"/><path d="M2 11h20"/><path d="m3.5 11 1.6 7.4a2 2 0 0 0 2 1.6h9.8c.9 0 1.8-.7 2-1.6l1.7-7.4"/><path d="m9 11 1 9"/><path d="m4.5 11 .1 8.1"/><path d="m19.5 11-.1 8.1"/><path d="m15 11-1 9"/></svg>,
            Image: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            Newspaper: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/><path d="M18 14h-8"/><path d="M15 18h-5"/><path d="M10 6h8v4h-8V6Z"/></svg>,
            Mail: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>,
            UsersViewfinder: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="10" cy="10" r="7" /><path d="M21 21l-6-6" /><path d="M7 10h6" /><path d="M10 7v6" /></svg>,
            MapLocation: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            Info: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            UpRightFromSquare: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>,
            Shield: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/></svg>,
        };

        const WeatherIcon = ({ type }) => {
            switch (type) {
                case 'sunny': return <Icons.Sun className="w-5 h-5 text-amber-500" />;
                case 'snowy': return <Icons.CloudSnow className="w-5 h-5 text-slate-400" />;
                case 'rainy': return <Icons.CloudRain className="w-5 h-5 text-blue-400" />;
                case 'cloudy': return <Icons.Cloud className="w-5 h-5 text-stone-400" />;
                default: return <Icons.CloudSnow className="w-5 h-5 text-stone-300" />;
            }
        };

        const ReactMarkdown = ({ children }) => <div dangerouslySetInnerHTML={{ __html: marked.parse(children) }} />;


        // --- Helper functions for time calculation ---
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1);
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); var d = R * c;
            return d.toFixed(1);
        }
        function deg2rad(deg) { return deg * (Math.PI/180) }

        const timeToMinutes = (timeStr) => {
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        };

        const minutesToTimeStr = (minutes) => {
            let h = Math.floor(minutes / 60);
            let m = Math.floor(minutes % 60);
             h = h % 24; 
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        };

        const parseStayDuration = (stayStr) => {
             if (!stayStr || stayStr === '-') return 0;
             if (stayStr === 'Overnight') return 0;
             if (stayStr.includes('hr')) {
                 return parseFloat(stayStr) * 60;
             }
             if (stayStr.includes('min')) {
                 return parseInt(stayStr);
             }
             return 0;
        };
        
        // --- Countdown Component ---
        const Countdown = () => {
            const targetDate = new Date('December 31, 2025 23:59:59').getTime();
            const [timeLeft, setTimeLeft] = useState(targetDate - new Date().getTime());

            useEffect(() => {
                const timer = setInterval(() => {
                    setTimeLeft(targetDate - new Date().getTime());
                }, 1000);
                return () => clearInterval(timer);
            }, [targetDate]);

            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            const isFinished = timeLeft < 0;

            return (
                <div className="text-center py-4 glass-panel rounded-lg border-2 border-yellow-500/50 shadow-2xl">
                    <h2 className="text-sm font-bold text-[#00FFFF] uppercase tracking-widest mb-2">TIME SQUARE 2026 COUNTDOWN</h2>
                    <div className="flex justify-center gap-4">
                        {isFinished ? (
                            <h1 className="text-4xl font-black countdown-style">HAPPY NEW YEAR 2026!</h1>
                        ) : (
                            <>
                                <div className="flex flex-col items-center">
                                    <span className="text-4xl md:text-5xl font-extrabold font-mono countdown-style">{String(days).padStart(2, '0')}</span>
                                    <span className="text-xs text-slate-400 font-bold mt-1">å¤© (Days)</span>
                                </div>
                                <span className="text-4xl md:text-5xl font-extrabold countdown-style">:</span>
                                <div className="flex flex-col items-center">
                                    <span className="text-4xl md:text-5xl font-extrabold font-mono countdown-style">{String(hours).padStart(2, '0')}</span>
                                    <span className="text-xs text-slate-400 font-bold mt-1">æ™‚ (Hours)</span>
                                </div>
                                <span className="text-4xl md:text-5xl font-extrabold countdown-style">:</span>
                                <div className="flex flex-col items-center">
                                    <span className="text-4xl md:text-5xl font-extrabold font-mono countdown-style">{String(minutes).padStart(2, '0')}</span>
                                    <span className="text-xs text-slate-400 font-bold mt-1">åˆ† (Minutes)</span>
                                </div>
                                <span className="hidden sm:inline text-4xl md:text-5xl font-extrabold countdown-style">:</span>
                                <div className="hidden sm:flex flex-col items-center">
                                    <span className="text-4xl md:text-5xl font-extrabold font-mono countdown-style">{String(seconds).padStart(2, '0')}</span>
                                    <span className="text-xs text-slate-400 font-bold mt-1">ç§’ (Seconds)</span>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };


        // --- CONSTANTS (A & B Combined) ---
        const RAW_KML_DATA = [
            { 
                dayId: "day1", 
                date: "12/31 (äºŒ)", 
                title: "è·¨å¹´æ­¡æ¨‚å‡ºç™¼", 
                themeColor: "bg-[#FFD700]", // Changed to Gold
                spots: [ 
                    { name: "æº«æš–çš„å®¶", lat: 25.0665561, lon: 121.5105023, desc: "æ—…ç¨‹èµ·é»ï¼Œæº–å‚™å‡ºç™¼è·¨å¹´ï¼", mapCode: "GPS" }, 
                    { name: "çµ±ä¸€æ¸¡å‡æ‘é¦¬æ­¦ç£æ¸¡å‡æœƒè­°ä¸­å¿ƒ", lat: 24.7671155, lon: 121.2177233, desc: "OPEN OPENï¼å…¥ä½æ­¡æ¨‚æ¸¡å‡æ‘ï¼Œæº–å‚™è¿æ¥ 2025ã€‚", mapCode: "GPS" } 
                ] 
            },
            { 
                dayId: "day2", 
                date: "01/01 (ä¸‰)", 
                title: "å…ƒæ—¦æ­·å²äººæ–‡ä¹‹æ—…", 
                themeColor: "bg-[#00FFFF]", // Changed to Cyan/Neon Blue
                spots: [ 
                    { name: "çµ±ä¸€æ¸¡å‡æ‘é¦¬æ­¦ç£æ¸¡å‡æœƒè­°ä¸­å¿ƒ", lat: 24.7671155, lon: 121.2177233, desc: "äº«å—æ¸¡å‡æ‘è¨­æ–½ï¼Œå…ƒæ—¦æ—©æ™¨ã€‚", mapCode: "GPS" }, 
                    { name: "1895ä¹™æœªä¿å°ç´€å¿µå…¬åœ’", lat: 24.948274, lon: 121.2054549, desc: "æ„Ÿå—æ­·å²å»ºç¯‰ä¹‹ç¾èˆ‡å…¬åœ’ç¶ æ„ã€‚", mapCode: "GPS" } 
                ] 
            }
        ];
        const EXCHANGE_RATE = 1.0; 
        const STAY_OPTIONS = ["30 min", "1 hr", "1.5 hr", "2 hr", "2.5 hr", "3 hr", "4 hr", "5 hr", "Overnight", "-"];
        const EXPENSE_CATEGORIES = [
            { id: 'food', label: 'é£²é£Ÿ', Icon: Icons.Coffee, color: 'text-[#FFD700]', bgColor: 'bg-[#FFD700]/30' },
            { id: 'shopping', label: 'è³¼ç‰©', Icon: Icons.ShoppingBag, color: 'text-[#00FFFF]', bgColor: 'bg-[#00FFFF]/30' },
            { id: 'transport', label: 'äº¤é€š', Icon: Icons.Car, color: 'text-[#457B9D]', bgColor: 'bg-[#A8DADC]' },
            { id: 'hotel', label: 'ä½å®¿', Icon: Icons.Hotel, color: 'text-[#1D3557]', bgColor: 'bg-[#BDE0FE]' },
            { id: 'ticket', label: 'é–€ç¥¨', Icon: Icons.Ticket, color: 'text-[#2A9D8F]', bgColor: 'bg-[#98F5E1]' },
            { id: 'fuel', label: 'åŠ æ²¹', Icon: Icons.Fuel, color: 'text-[#BC4749]', bgColor: 'bg-[#FFB4A2]' },
            { id: 'other', label: 'å…¶ä»–', Icon: Icons.MoreHorizontal, color: 'text-stone-600', bgColor: 'bg-stone-200' },
        ];
        const FAMILY_MEMBERS = ["è”£ç¿Šé½Š", "è”£å®¥æ˜‡", "é™³æ¦®èŠ³", "è”£å®—æ†"];

        // --- Constants for INFO Page (A) ---
        const NAV_BUTTONS_NEW = [
            { title: "æ‰¾åŠ æ²¹ç«™", query: "åŠ æ²¹ç«™ near me", icon: Icons.Fuel },
            { title: "æ‰¾ä¾¿åˆ©å•†åº—", query: "ä¾¿åˆ©å•†åº— near me", icon: Icons.Store },
            { title: "æ‰¾é¤å»³ç¾é£Ÿ", query: "é¤å»³ ç¾é£Ÿ near me", icon: Icons.Utensils },
            { title: "æ‰¾ç™¾è²¨è³¼ç‰©", query: "ç™¾è²¨å…¬å¸ è³¼ç‰© near me", icon: Icons.ShoppingBasket },
        ];
        const REGION_DATA = {
            taoyuan: {
                label: "æ¡ƒåœ’å¸‚", 
                color: "text-red-400",
                souvenirs: [
                    { name: "é¾æ½­èŠ±ç”Ÿç³–", desc: "å¤æ—©å‘³æ‰‹å·¥è£½ä½œ" },
                    { name: "å¤§æºªè±†å¹²", desc: "å¤šç¨®å£å‘³è±†å¹²ç¦®ç›’" },
                    { name: "å¾©èˆˆé„‰æ°´èœœæ¡ƒä¹¾", desc: "æ‹‰æ‹‰å±±é™å®šé¢¨å‘³" }
                ]
            }
        };
        const FLIGHT_INFO_A = {
            outbound: { flight: "é–‹è»Š", from: "å®¶", to: "é¦¬æ­¦ç£", dep: "09:00", arr: "10:30", date: "12/31", duration: "1.5 hr", distance: "60 km" },
            inbound: { flight: "é–‹è»Š", from: "é¦¬æ­¦ç£", to: "å®¶", dep: "15:00", arr: "16:30", date: "01/01", duration: "1.5 hr", distance: "60 km" }
        };
        const HOTEL_INFO_A = [
            { day: "12/31", name: "çµ±ä¸€æ¸¡å‡æ‘é¦¬æ­¦ç£æ¸¡å‡æœƒè­°ä¸­å¿ƒ", location: "æ–°ç«¹é—œè¥¿", desc: "è·¨å¹´å¤œä½å®¿", link: "http://googleusercontent.com/maps.google.com/5" },
        ];
        const RENTAL_INFO_LIST = [
            { label: "è»Šè¼›", value: "è‡ªå®¶è»Š (Toyota Sienta)" },
            { label: "é‡Œç¨‹", value: "å‡ºç™¼å‰é‡Œç¨‹è¨˜éŒ„: 35000 km" },
            { label: "æ²¹ç®±", value: "æ»¿æ²¹å‡ºç™¼" },
            { label: "å‚™èƒ/å·¥å…·", value: "å·²æª¢æŸ¥èƒå£“èˆ‡éš¨è»Šå·¥å…·" },
            { label: "ETC", value: "å·²ç¢ºèªå„²å€¼é‡‘é¡" },
        ];


        // --- Constants for AI Guard (B) - Tokyo Data (Dummy for Integration) ---
        const FLIGHT_INFO_B = {
            outbound: { flight: "JX802", airline: "æ˜Ÿå®‡èˆªç©º", from: "TPE", to: "NRT", dep: "10:10", arr: "2026/1/30 14:20", date: "2026/1/30" },
            inbound: { flight: "JX801", airline: "æ˜Ÿå®‡èˆªç©º", from: "NRT", to: "TPE", dep: "15:30", arr: "2026/2/3 18:45", date: "2026/2/3" }
        };

        const HOTEL_INFO_B = [
            { day: "1/30", name: "Hotel Torifito Kashiwanoha", location: "åƒè‘‰æŸå¸‚" },
            { day: "1/31", name: "REFå¤§å®® by Vessel Hotels", location: "åŸ¼ç‰å¤§å®®" },
            { day: "2/1", name: "HOTEL COMENTO YOKOHAMA", location: "æ©«æ¿±é—œå…§" },
            { day: "2/2", name: "æ—¥å’Œé£¯åº—èˆæ¿±", location: "åƒè‘‰æµ¦å®‰" },
        ];

        const AI_GUARD_DATA = [
            {
                date: "1/30 (äº”) Fri.",
                spots: [
                    { name: "èˆªç©ºç§‘å­¸åšç‰©é¤¨", location: "æˆç”°æ©Ÿå ´æ—", tags: ["10:00-17:00"], timeHint: "14:30", icon: "âœˆï¸", url: "http://www.aeromuseum.or.jp/", strategy: "é€™è£¡æœ€ç†±é–€çš„æ˜¯ã€Œ747 æ©Ÿé ­å°è¦½ã€èˆ‡ã€Œå¤§å‹æ¨¡æ“¬é§•é§›è‰™ã€ï¼Œéœ€è¦å…¥é¤¨å¾Œé ç´„ã€‚" }
                ]
            },
            {
                date: "1/31 (å…­) Sat.",
                spots: [
                    { name: "è¶³ç«‹å€ç”Ÿç‰©åœ’", location: "ç«¹ä¹‹å¡šç«™", tags: ["09:30-16:30"], timeHint: "09:30", icon: "ğŸ¦‹", url: "https://seibutuen.jp/", strategy: "å†¬å­£ã€Œå¤§æº«å®¤ã€ç‰¹åˆ¥å—æ­¡è¿ï¼Œæš–æ°£å……è¶³ä¸”è´è¶é£›èˆã€‚" },
                    { name: "å¤§å®®éµé“åšç‰©é¤¨", location: "åŸ¼ç‰å¤§å®®", tags: ["éœ€é è³¼", "10:00-17:00"], timeHint: "13:00", icon: "ğŸš‚", url: "https://www.railway-museum.jp/", strategy: "é–€ç¥¨å¿…é ˆæå‰è²·å¥½ã€‚æƒ³é«”é©—ã€Œè¿·ä½ é§•é§›åˆ—è»Šã€å‹™å¿…ä¸‹è¼‰å®˜æ–¹ App æŠ½ç±¤ã€‚" }
                ]
            },
            {
                date: "2/1 (æ—¥) Sun.",
                spots: [
                    { name: "å¤šæ‘©å…­éƒ½ç§‘å­¸é¤¨", location: "è¥¿æ±äº¬å¸‚", tags: ["å¤©è±¡å„€", "09:30-17:00"], timeHint: "09:30", icon: "ğŸª", url: "https://www.tamarokuto.or.jp/", strategy: "æœ‰ã€Œé‡‘æ°ä¸–ç•Œç´€éŒ„ã€èªè­‰çš„å¤©è±¡å„€ï¼Œå»ºè­°å…ˆç¢ºèªæ˜Ÿç©ºåŠ‡å ´å ´æ¬¡ã€‚" },
                    { name: "é„‰åœŸä¹‹æ£®åšç‰©é¤¨", location: "åºœä¸­å¸‚", tags: ["æ¢…èŠ±ç¥­", "09:00-17:00"], timeHint: "14:00", icon: "ğŸŒ¸", url: "http://www.fuchu-cpf.or.jp/museum/", strategy: "æ¢…èŠ±ç¥­åˆæœŸï¼Œå¤æ°‘å®¶å»ºç¯‰æ­é…æ—©é–‹æ¢…èŠ±éå¸¸ç¾ã€‚" }
                ]
            },
            {
                date: "2/2 (ä¸€) Mon.",
                spots: [
                    { name: "åˆå‘³é“ç´€å¿µé¤¨ æ©«æ¿±", location: "æ©«æ¿±", tags: ["é€±äºŒä¼‘", "10:00-18:00"], timeHint: "10:00", icon: "ğŸœ", url: "https://www.cupnoodles-museum.jp/zh-tw/yokohama/", strategy: "ã€Œæˆ‘çš„åˆå‘³é“å·¥å» ã€éå¸¸ç†±é–€ï¼Œå¼·çƒˆå»ºè­°ä¸€å€‹æœˆå‰ä¸Šç¶²é ç´„ã€‚" },
                    { name: "ä¸‰è±æ¸¯æœªä¾†æŠ€è¡“é¤¨", location: "æ©«æ¿±", tags: ["10:00-17:00", "é€±äºŒä¼‘"], timeHint: "13:30", icon: "ğŸš€", url: "https://www.mhi.com/jp/company/overview/museum/minatomirai", strategy: "äº®é»æ˜¯ç«ç®­å¼•æ“å¯¦ç‰©èˆ‡æ·±æµ·èª¿æŸ¥èˆ¹ã€‚" },
                    { name: "å“å·æ°´æ—é¤¨", location: "å¤§æ£®æµ·å²¸ç«™", tags: ["é€±äºŒä¼‘", "10:00-17:00"], timeHint: "16:00", icon: "ğŸ¬", url: "https://www.aquarium.gr.jp/", strategy: "è«‹æ³¨æ„ä¸è¦è·‘éŒ¯åˆ°å“å·ç‹å­é£¯åº—é‚£é–“ã€‚é€™é–“åœ¨ã€Œå¤§æ£®æµ·å²¸ç«™ã€ã€‚" }
                ]
            },
            {
                date: "2/3 (äºŒ) Tue.",
                spots: [
                    { name: "èˆ¹æ©‹å®‰å¾’ç”Ÿå…¬åœ’", location: "åƒè‘‰èˆ¹æ©‹", tags: ["09:30-16:00"], timeHint: "09:30", icon: "ğŸ¡", url: "https://www.park-funabashi.or.jp/and/", strategy: "å†¬å¤©é–‰åœ’æ™‚é–“æ˜¯ 16:00ã€‚å»ºè­°ä¸Šåˆå°±åˆ°ï¼Œå…ˆå»ç©å¤§å‹æ»¾è¼ªæºœæ»‘æ¢¯ã€‚" }
                ]
            }
        ];


        // --- Daily Detail Modal Component (A) ---
        const DailyDetailModal = ({ isOpen, onClose, dayData, allExpenses, spotTicketCounts }) => {
            if (!isOpen || !dayData) return null;

            const dayExpensesList = [];
            
            dayData.spots.forEach(spot => {
                const spotExpenses = allExpenses[spot.id] || [];
                spotExpenses.forEach(record => {
                    const dateMatch = record.note ? record.note.match(/^(\d{4}[-/]\d{2}[-/]\d{2}\s+\d{2}:\d{2})\s+(.*)$/) : null;
                    dayExpensesList.push({
                        type: 'manual',
                        spotName: spot.name,
                        category: record.category,
                        amount: record.amount,
                        note: dateMatch ? dateMatch[2] : (record.note || "æ¶ˆè²»"),
                        date: dateMatch ? dateMatch[1] : null,
                        id: record.id
                    });
                });

                if (spot.ticket) {
                    const counts = spotTicketCounts[spot.id] || { adult: 2, child: 2 };
                    const ticketCost = (spot.ticket.adult * counts.adult + spot.ticket.child * counts.child);
                    if (ticketCost > 0) {
                        dayExpensesList.push({
                            type: 'ticket',
                            spotName: spot.name,
                            category: 'ticket',
                            amount: ticketCost,
                            note: `é–€ç¥¨ (å¤§${counts.adult} å°${counts.child})`,
                            id: `ticket-${spot.id}`
                        });
                    }
                }
            });

            return (
                <div className="fixed inset-0 bg-stone-900/80 backdrop-blur-sm flex items-center justify-center z-[130] p-4 animate-in fade-in duration-200" onClick={onClose}>
                    <div className="glass-panel rounded-2xl p-6 w-full max-w-sm shadow-2xl max-h-[70vh] flex flex-col bg-[#0f172a] border border-slate-700" onClick={e => e.stopPropagation()}>
                         <div className="flex justify-between items-center mb-4 border-b border-slate-700 pb-3">
                            <div>
                                <div className="text-xs font-bold text-slate-400 mb-1">{dayData.date}</div>
                                <h3 className="font-black text-xl text-slate-200">{dayData.title}</h3>
                            </div>
                            <button onClick={onClose} className="p-1 rounded-full hover:bg-slate-700 text-slate-400 transition-colors"><Icons.X size={20}/></button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto space-y-3 pr-2">
                            {dayExpensesList.length === 0 ? (
                                <div className="text-center text-slate-500 py-8 flex flex-col items-center">
                                    <Icons.Wallet size={32} className="mb-2 opacity-50"/>
                                    <span>æœ¬æ—¥å°šç„¡èŠ±è²»ç´€éŒ„</span>
                                </div>
                            ) : (
                                dayExpensesList.map((item, idx) => (
                                    <div key={item.id || idx} className="bg-[#1e293b] p-3 rounded-xl border border-slate-700 flex justify-between items-center">
                                        <div>
                                            <div className="text-xs text-[#FFD700] font-bold mb-0.5">{item.spotName}</div>
                                            <div className="flex flex-col">
                                                {item.date && <span className="text-[10px] text-slate-500 block">{item.date}</span>}
                                                <span className="text-sm font-bold text-slate-300">{item.note}</span>
                                            </div>
                                        </div>
                                        <div className="font-mono font-bold text-slate-200 text-lg">NT${item.amount.toLocaleString()}</div>
                                    </div>
                                ))
                            )}
                        </div>

                        <div className="mt-4 pt-4 border-t border-slate-700 flex justify-between items-center">
                            <span className="text-sm font-bold text-slate-400 uppercase tracking-wider">Total</span>
                            <span className="text-2xl font-mono font-black text-[#FF6B6B]">NT${dayData.totalJpy.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            );
        };

        // --- API Key Modal Component (A & B Combined) ---
        const ApiKeyModal = ({ isOpen, onClose }) => {
            const [key, setKey] = useState('');
            
            useEffect(() => {
                const storedKey = localStorage.getItem('gemini_api_key');
                if (storedKey) setKey(storedKey);
            }, [isOpen]);

            const handleSave = () => {
                localStorage.setItem('gemini_api_key', key.trim());
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-stone-800/80 backdrop-blur-sm flex items-center justify-center z-[120] p-4 animate-in fade-in duration-200">
                    <div className="glass-panel rounded-2xl p-6 w-full max-w-sm shadow-2xl border border-[#00FFFF]/30">
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="font-bold text-lg text-slate-200 flex items-center gap-2">
                                <Icons.Settings size={20} className="text-[#FFD700]"/> è¨­å®š AI é‡‘é‘°
                            </h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-white p-1 rounded-full hover:bg-slate-700/50 transition-colors">
                                <Icons.X size={20} />
                            </button>
                        </div>
                        <p className="text-xs text-slate-400 mb-4">
                            å…§å»ºé‡‘é‘°å·²å•Ÿç”¨ï¼è‹¥æ‚¨æœ‰è‡ªå·±çš„ Key å¯åœ¨æ­¤æ›´æ›ã€‚
                        </p>
                        <input 
                            type="password" 
                            value={key} 
                            onChange={(e) => setKey(e.target.value)} 
                            placeholder="è²¼ä¸Š API Key (é¸å¡«)"
                            className="w-full bg-slate-700 rounded-lg p-3 text-sm mb-4 outline-none focus:ring-2 focus:ring-[#00FFFF] text-white"
                        />
                        <div className="flex gap-2">
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" className="flex-1 text-center py-2 rounded-lg border border-slate-600 text-xs font-bold text-slate-400 hover:bg-slate-700">
                                å–å¾— Key
                            </a>
                            <button onClick={handleSave} className="flex-1 bg-[#00FFFF] text-slate-900 py-2 rounded-lg text-sm font-bold hover:bg-[#4ECDC4]">
                                å„²å­˜
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- App Component (A & B Integrated) ---
        function App() {
            const [activeTab, setActiveTab] = useState('itinerary'); 
            const [activeMainTab, setActiveMainTab] = useState('itinerary'); 
            const [selectedDay, setSelectedDay] = useState('all'); 
            
            const [userLocation, setUserLocation] = useState(null);
            const [isLocating, setIsLocating] = useState(false);
            const [locationError, setLocationError] = useState(null);
            const [infoRegion, setInfoRegion] = useState("taoyuan");
            const [aiSouvenirs, setAiSouvenirs] = useState(null);
            const [isAiSouvenirLoading, setIsAiSouvenirLoading] = useState(false);
            const [aiNews, setAiNews] = useState(null);
            const [isAiNewsLoading, setIsAiNewsLoading] = useState(false);
            
            const [spotTicketCounts, setSpotTicketCounts] = useState(() => {
                const saved = localStorage.getItem('taoyuan_trip_2025_spot_tickets');
                return saved ? JSON.parse(saved) : {};
            });

            const [expenses, setExpenses] = useState({});
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isKeyModalOpen, setIsKeyModalOpen] = useState(false);
            const [currentEditingSpot, setCurrentEditingSpot] = useState(null);
            const [expenseForm, setExpenseForm] = useState({ category: 'food', amount: '', note: '' });
            const [isAnalyzingReceipt, setIsAnalyzingReceipt] = useState(false);
            const [pendingReceipts, setPendingReceipts] = useState([]);
            const [quotaStatus, setQuotaStatus] = useState({ type: 'normal', text: 'API é¡åº¦æ­£å¸¸' });

            const [transportModes, setTransportModes] = useState({});
            
            const [calcInput, setCalcInput] = useState("");
            const [calcResult, setCalcResult] = useState("");
            
            const [photoSearchLocation, setPhotoSearchLocation] = useState("");
            const [photoSearchPeople, setPhotoSearchPeople] = useState([]);
            const [photoSearchStatus, setPhotoSearchStatus] = useState({ text: "è«‹è¼¸å…¥åœ°é»æˆ–é»æ“Šå®šä½", type: "normal" });
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markerInstanceRef = useRef(null);
            
            const [activeTipSpotId, setActiveTipSpotId] = useState(null);
            const [aiTips, setAiTips] = useState({});
            const [isTipLoading, setIsTipLoading] = useState(false);

            const [dayStartTimes, setDayStartTimes] = useState(() => {
                const initial = {};
                RAW_KML_DATA.forEach(day => initial[day.dayId] = "09:00");
                const saved = localStorage.getItem('taoyuan_trip_2025_start_times');
                return saved ? JSON.parse(saved) : initial;
            });

            const [actualDepartures, setActualDepartures] = useState(() => {
                const saved = localStorage.getItem('taoyuan_trip_2025_departures');
                return saved ? JSON.parse(saved) : {};
            });
            const [stays, setStays] = useState(() => {
                 const saved = localStorage.getItem('taoyuan_trip_2025_stays');
                 return saved ? JSON.parse(saved) : {};
            });
            const [tripData, setTripData] = useState([]);

            const [isDailyDetailOpen, setIsDailyDetailOpen] = useState(false);
            const [selectedDailyStats, setSelectedDailyStats] = useState(null);

            const [isEmailModalOpen, setIsEmailModalOpen] = useState(false);
            const [emailInput, setEmailInput] = useState("");
            const [isSendingEmail, setIsSendingEmail] = useState(false);

            const [aiLoading, setAiLoading] = useState(false);
            const [flightAnalysis, setFlightAnalysis] = useState(null);
            const [hotelAnalysis, setHotelAnalysis] = useState({});
            const [spotAnalysis, setSpotAnalysis] = useState({});
            const [aiInput, setAiInput] = useState("");
            const [aiGeneralResult, setAiGeneralResult] = useState("");


            // --- Persistence & Initialization (A) ---
            useEffect(() => { 
                const saved = localStorage.getItem('taoyuan_trip_2025_expenses'); 
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed && typeof parsed === 'object') { setExpenses(parsed); }
                    } catch(e) { console.error(e); }
                } 
                if (window.emailjs) {
                    window.emailjs.init("mYOFMMnqLdDxR0wjj");
                }
            }, []);
            useEffect(() => { localStorage.setItem('taoyuan_trip_2025_expenses', JSON.stringify(expenses)); }, [expenses]);
            useEffect(() => { localStorage.setItem('taoyuan_trip_2025_spot_tickets', JSON.stringify(spotTicketCounts)); }, [spotTicketCounts]);
            useEffect(() => { localStorage.setItem('taoyuan_trip_2025_start_times', JSON.stringify(dayStartTimes)); }, [dayStartTimes]);
            useEffect(() => { localStorage.setItem('taoyuan_trip_2025_departures', JSON.stringify(actualDepartures)); }, [actualDepartures]);
            useEffect(() => { localStorage.setItem('taoyuan_trip_2025_stays', JSON.stringify(stays)); }, [stays]);

            // --- RECALCULATE LOGIC (A) ---
             useEffect(() => {
                setTripData(prevData => {
                     return RAW_KML_DATA.map(day => {
                        const startTimeStr = dayStartTimes[day.dayId] || "09:00";
                        let currentMinutes = timeToMinutes(startTimeStr);

                        const processedSpots = day.spots.map((rawSpot, index) => {
                            const spotId = `${day.dayId}-s${index}`;
                            
                            const stayStr = stays[spotId] || "1.5 hr";
                            const stayMinutes = parseStayDuration(stayStr);

                            const arrivalTimeStr = minutesToTimeStr(currentMinutes);
                            
                            let departureMinutes;
                            let isDeparted = false;
                            let actualDepTime = null;

                            if (actualDepartures[spotId]) {
                                actualDepTime = actualDepartures[spotId];
                                departureMinutes = timeToMinutes(actualDepTime);
                                isDeparted = true;
                            } else {
                                departureMinutes = currentMinutes + stayMinutes;
                            }
                            const departureTimeStr = minutesToTimeStr(departureMinutes);

                            let nextStopInfo = null;
                            let travelMinutes = 0;

                            if (index < day.spots.length - 1) {
                                const nextSpot = day.spots[index + 1];
                                const dist = getDistanceFromLatLonInKm(rawSpot.lat, rawSpot.lon, nextSpot.lat, nextSpot.lon);
                                const mode = transportModes[spotId] || 'car';
                                const speed = mode === 'car' ? 40 : 4; 
                                travelMinutes = Math.round((dist / speed) * 60);
                                
                                const displayDriveMins = Math.round((dist / 40) * 60); 
                                const displayWalkMins = Math.round((dist / 4) * 60);

                                nextStopInfo = {
                                    name: nextSpot.name,
                                    distance: `${dist} km`,
                                    driveTime: displayDriveMins > 60 ? `${Math.floor(displayDriveMins/60)}hr ${displayDriveMins%60}m` : `${displayDriveMins}m`,
                                    walkTime: displayWalkMins > 60 ? `${Math.floor(displayWalkMins/60)}hr ${displayWalkMins%60}m` : `${displayWalkMins}m`,
                                    navLink: `https://www.google.com/maps/dir/?api=1&origin=${rawSpot.lat},${rawSpot.lon}&destination=${nextSpot.lat},${nextSpot.lon}&travelmode=driving`
                                };
                            }

                            currentMinutes = departureMinutes + travelMinutes;

                            return { 
                                ...rawSpot, 
                                id: spotId, 
                                time: arrivalTimeStr, 
                                stay: stayStr,
                                departureTime: departureTimeStr,
                                isDeparted: isDeparted,
                                actualDepTime: actualDepTime,
                                mapcodeDisplay: rawSpot.mapCode || "GPS", 
                                weather: ["sunny", "cloudy"][Math.floor(Math.random()*2)], 
                                temp: "16Â°C",
                                gmapLink: `https://www.google.com/maps/search/?api=1&query=${rawSpot.lat},${rawSpot.lon}`, 
                                nextStop: nextStopInfo,
                                ticket: rawSpot.ticket || null 
                            };
                        });
                        return { ...day, spots: processedSpots };
                    });
                });
            }, [dayStartTimes, actualDepartures, transportModes, stays]);


            // --- Map Initialization (A) ---
            useEffect(() => {
                if (activeMainTab === 'stats' && mapContainerRef.current) {
                    if (!mapInstanceRef.current) {
                        mapInstanceRef.current = L.map(mapContainerRef.current).setView([23.973875, 120.982024], 7);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: 'Â© OSM',
                            maxZoom: 19
                        }).addTo(mapInstanceRef.current);
                    }
                    setTimeout(() => { mapInstanceRef.current.invalidateSize(); }, 100);
                }
            }, [activeMainTab]);


            // --- AI Guard Functions (B) ---
            const checkFlight = async () => {
                setAiLoading(true);
                setFlightAnalysis("ğŸ” AI é©—è­‰ä¸­...");
                try {
                    const prompt = `æª¢æŸ¥èˆªç­ï¼šå»ç¨‹ ${FLIGHT_INFO_B.outbound.flight} (${FLIGHT_INFO_B.outbound.date}) èˆ‡ å›ç¨‹ ${FLIGHT_INFO_B.inbound.flight} (${FLIGHT_INFO_B.inbound.date})ã€‚è«‹æŸ¥è©¢è¿‘æœŸæº–é»ç‡ã€èˆªå»ˆç•°å‹•èˆ‡æ³¨æ„äº‹é … (ç¹é«”ä¸­æ–‡)ã€‚`;
                    const res = await generateGeminiContent(prompt, null, true);
                    setFlightAnalysis(res);
                } catch(e) { 
                    setFlightAnalysis("èˆªç­è³‡è¨Šé©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key æˆ–ç¶²è·¯ã€‚");
                    if(e.message.includes("KEY")) setIsKeyModalOpen(true);
                }
                setAiLoading(false);
            };

            const checkHotel = async (hName) => {
                setAiLoading(true);
                setHotelAnalysis(p => ({...p, [hName]: "ğŸ” AI åˆ†æä¸­..."}));
                try {
                    const prompt = `é£¯åº—é˜²é›·æª¢æŸ¥ï¼š${hName} (æ±äº¬åœ°å€)ã€‚è«‹æª¢æŸ¥ï¼š1. é™„è¿‘çš„è¶…å¸‚/ä¾¿åˆ©å•†åº—? 2. é£¯åº—é™„è¨­åœè»Šå ´æˆ–æ˜¯åˆç´„åœè»Šå ´è³‡è¨Š? 3. è¿‘æœŸæ˜¯å¦æœ‰åš´é‡è² è©•(å™ªéŸ³/æ¸…æ½”)? 4. é›¢è»Šç«™å¯¦éš›æ­¥è¡Œè·é›¢ã€‚è«‹ç°¡çŸ­å›è¦†ã€‚`;
                    const res = await generateGeminiContent(prompt, null, true);
                    setHotelAnalysis(p => ({...p, [hName]: res}));
                } catch(e) { 
                    setHotelAnalysis(p => ({...p, [hName]: "åˆ†æå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key æˆ–ç¶²è·¯ã€‚"})); 
                    if(e.message.includes("KEY")) setIsKeyModalOpen(true);
                }
                setAiLoading(false);
            };

            const checkSpot = async (spot, dateStr) => {
                setAiLoading(true);
                const fullTime = `2026å¹´${dateStr} ${spot.timeHint || ''}`.trim();
                const key = spot.name + fullTime;
                
                setSpotAnalysis(p => ({...p, [key]: "ğŸ” æƒé›·ä¸­..."}));
                try {
                    const prompt = `æ™¯é»æƒé›·ï¼š${spot.name}ã€‚é è¨ˆåˆ°è¨ªæ™‚é–“ï¼š${fullTime}ã€‚è«‹æª¢æŸ¥ï¼š1.è©²æ—¥æœŸæ™‚é–“æ˜¯å¦ç‡Ÿæ¥­/å…¬ä¼‘? 2.è¿‘æœŸæ˜¯å¦æœ‰æ•´ä¿®æˆ–é—œé–‰? 3.å»ºè­°åœç•™æ™‚é–“èˆ‡é¿é›·é‡(å¦‚æ’éšŠéé•·)ã€‚`;
                    const res = await generateGeminiContent(prompt, null, true);
                    setSpotAnalysis(p => ({...p, [key]: res}));
                } catch(e) { 
                    setSpotAnalysis(p => ({...p, [key]: "åˆ†æå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key æˆ–ç¶²è·¯ã€‚"}));
                    if(e.message.includes("KEY")) setIsKeyModalOpen(true);
                }
                setAiLoading(false);
            };

            const analyzeGeneral = async () => {
                if(!aiInput) return;
                setAiLoading(true);
                setAiGeneralResult("ğŸ” AI åˆ†æä¸­...");
                try {
                    const res = await generateGeminiContent(`è«‹åˆ†æé€™æ®µæ—…éŠè³‡è¨Šçš„é¢¨éšªèˆ‡æ­£ç¢ºæ€§ï¼š${aiInput}`, null, true);
                    setAiGeneralResult(res);
                } catch(e) { 
                    setAiGeneralResult("åˆ†æå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key æˆ–ç¶²è·¯ã€‚");
                    if(e.message.includes("KEY")) setIsKeyModalOpen(true);
                }
                setAiLoading(false);
            };


            // --- Other Handlers (A) ---
            const getTicketCounts = (spotId) => spotTicketCounts[spotId] || { adult: 2, child: 2 };
            const updateSpotTicketCount = (spotId, type, delta) => {
                setSpotTicketCounts(prev => {
                    const current = prev[spotId] || { adult: 2, child: 2 };
                    const newValue = Math.max(0, current[type] + delta);
                    return { ...prev, [spotId]: { ...current, [type]: newValue } };
                });
            };

            const handleTransportToggle = (spotId) => {
                setTransportModes(prev => ({ ...prev, [spotId]: prev[spotId] === 'walk' ? 'car' : 'walk' }));
            };

            const handleStayChangeNew = (spotId, newStay) => {
                setStays(prev => ({ ...prev, [spotId]: newStay }));
            };

            const handleDayStartTimeChange = (dayId, newTime) => {
                setDayStartTimes(prev => ({ ...prev, [dayId]: newTime }));
            };

            const handleDepartureToggle = (spotId) => {
                setActualDepartures(prev => {
                    const newState = { ...prev };
                    if (newState[spotId]) {
                        delete newState[spotId];
                    } else {
                        const now = new Date();
                        const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
                        newState[spotId] = timeStr;
                    }
                    return newState;
                });
            };

            const fetchAiSouvenirs = async (lat, lon) => {
                setIsAiSouvenirLoading(true);
                setAiSouvenirs(null);
                try {
                    const prompt = `æˆ‘ç¾åœ¨åœ¨å°ç£çš„åº§æ¨™: ç·¯åº¦ ${lat}, ç¶“åº¦ ${lon}ã€‚è«‹æ¨è–¦ 3 å€‹é€™å€‹åœ°é»é™„è¿‘å¿…è²·çš„çŸ¥åä¼´æ‰‹ç¦®æˆ–åœŸç”¢ã€‚è«‹ç›´æ¥å›å‚³ä¸€å€‹ JSON Arrayï¼Œæ ¼å¼å¦‚ä¸‹ï¼Œä¸è¦æœ‰ Markdown æ¨™è¨˜æˆ–å…¶ä»–æ–‡å­—ï¼š
                    [{"name": "ä¼´æ‰‹ç¦®åç¨±", "desc": "ç°¡çŸ­ä»‹ç´¹(20å­—å…§)"}]`;
                    
                    let text = await generateGeminiContent(prompt, null, true);
                    text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    const data = JSON.parse(text);
                    if (Array.isArray(data)) {
                        setAiSouvenirs(data);
                    } else {
                        throw new Error("Format error");
                    }
                } catch (e) {
                    setAiSouvenirs([{name: "æ¨è–¦å¤±æ•—", desc: "ç„¡æ³•å–å¾— AI æ¨è–¦ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"}]);
                } finally {
                    setIsAiSouvenirLoading(false);
                }
            };

            const fetchAiNews = async (lat, lon) => {
                setIsAiNewsLoading(true);
                setAiNews(null);
                try {
                    const prompt = `æˆ‘ç¾åœ¨åœ¨å°ç£çš„åº§æ¨™: ç·¯åº¦ ${lat}, ç¶“åº¦ ${lon}ã€‚è«‹åˆ†æé€™å€‹åœ°é»(è«‹è‡ªè¡Œåˆ¤æ–·è¡Œæ”¿å€)ï¼Œä¸¦åˆ—å‡º 4 å€‹èˆ‡æ­¤åœ°é«˜åº¦ç›¸é—œçš„ã€Œæ–°èé—œéµå­—ã€æˆ–ã€Œé—œæ³¨ç„¦é»ã€ã€‚è«‹ä¾ç…§ã€Œé‡è¦æ€§ã€èˆ‡ã€Œç†±é–€åº¦ã€æ’åºï¼Œä¸¦å„ªå…ˆé—œæ³¨ä»¥ä¸‹é¢å‘ï¼š1. æœ€æ–°ç†±é–€æ—…éŠæƒ…å ± 2. äº¤é€šèˆ‡æ—…éŠå®‰å…¨ 3. å±…ä½èˆ‡ç’°å¢ƒå®‰å…¨ 4. åœ¨åœ°ç†±é–€æ°‘ç”Ÿè­°é¡Œã€‚è«‹ç›´æ¥å›å‚³ä¸€å€‹ JSON Arrayï¼Œæ ¼å¼å¦‚ä¸‹ï¼Œä¸è¦æœ‰ Markdown æ¨™è¨˜æˆ–å…¶ä»–æ–‡å­—ï¼š
                    [{"title": "é¡¯ç¤ºæ¨™é¡Œ(ä¾‹å¦‚:2025æœ€æ–°æ‰“å¡é»)", "query": "æœå°‹é—œéµå­—(ä¾‹å¦‚:å…§æ¹– æ–°æ™¯é» 2025)"}]`;
                    
                    let text = await generateGeminiContent(prompt, null, true);
                    text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    const data = JSON.parse(text);
                    if (Array.isArray(data)) {
                        setAiNews(data);
                    } else {
                        throw new Error("Format error");
                    }
                } catch (e) {
                    setAiNews([
                        { title: "åœ¨åœ°ç†±é–€æ™¯é»", query: "é™„è¿‘ ç†±é–€æ™¯é» æ–°è" },
                        { title: "äº¤é€šèˆ‡å®‰å…¨è³‡è¨Š", query: "é™„è¿‘ äº¤é€šå®‰å…¨ æ–°è" }
                    ]);
                } finally {
                    setIsAiNewsLoading(false);
                }
            };

            const handleGetLocation = () => {
                if (!navigator.geolocation) {
                  setLocationError("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
                  return;
                }
                
                setIsLocating(true);
                setLocationError(null);

                const options = { enableHighAccuracy: true, timeout: 30000, maximumAge: 600000 };

                navigator.geolocation.getCurrentPosition(
                  (position) => {
                    setUserLocation({ lat: position.coords.latitude, lon: position.coords.longitude });
                    setIsLocating(false);
                    fetchAiSouvenirs(position.coords.latitude, position.coords.longitude);
                    fetchAiNews(position.coords.latitude, position.coords.longitude);
                  },
                  (error) => {
                    let errorMsg = "ç„¡æ³•å–å¾—ä½ç½®";
                    if (error.code === 1) errorMsg = "å®šä½è¢«æ‹’çµ•ï¼šè«‹æª¢æŸ¥ç€è¦½å™¨æˆ–é›»è…¦è¨­å®š";
                    else if (error.code === 2) errorMsg = "ä½ç½®ä¸å¯ç”¨ï¼šè«‹ç¢ºèª Wi-Fi å·²é–‹å•Ÿ";
                    else if (error.code === 3) errorMsg = "å®šä½é€¾æ™‚ï¼šå®¤å…§è¨Šè™Ÿä¸ä½³ï¼Œè«‹é‡è©¦";
                    
                    setLocationError(errorMsg);
                    setIsLocating(false);
                  },
                  options
                );
            };

            const handleGetSpotTip = async (spot, date) => {
                if (activeTipSpotId === spot.id) { setActiveTipSpotId(null); return; }
                setActiveTipSpotId(spot.id);
                if (aiTips[spot.id]) return;

                setIsTipLoading(true);
                try {
                    const prompt = `é‡å°æ™¯é»ã€Œ${spot.name}ã€ï¼Œé è¨ˆé€ è¨ªæ—¥æœŸç‚ºã€Œ${date}ã€ã€‚è«‹åˆ©ç”¨ Google Search æŸ¥è­‰ä¸¦æ‰®æ¼”å°ˆæ¥­å°éŠï¼Œæä¾›ã€Œé˜²é›·æ—…éŠæ”»ç•¥ã€ï¼š
ğŸ” æŸ¥è­‰æŠ€å·§ï¼šæä¾›åœ¨ Google Maps æˆ–fbæœå°‹æœ€æ–°ç‡Ÿæ¥­ç‹€æ³çš„å…·é«”é—œéµå­—ã€‚âš ï¸ é¢¨éšªè©•ä¼°ï¼šç¢ºèªè©²æ—¥æœŸæ˜¯å¦ç‚ºå…¬ä¼‘æ—¥ï¼Ÿæ­¤å­£ç¯€æ˜¯å¦æœ‰å¸¸è¦‹ç¶­ä¿®ï¼Ÿæ˜¯å¦éœ€é ç´„ï¼ŸğŸ’¡ æ¨è–¦å‚™æ¡ˆï¼šè¬ä¸€æ²’é–‹ï¼Œæ¨è–¦é™„è¿‘è»Šç¨‹6å…¬é‡Œå¯é”çš„ä¸€å€‹æ›¿ä»£æ™¯é»æˆ–é¤å»³ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œèªæ°£å°ˆæ¥­è²¼å¿ƒï¼Œæ¢åˆ—å¼å‘ˆç¾ï¼Œç¸½å­—æ•¸ 150 å­—ä»¥å…§ã€‚`;

                    const tip = await generateGeminiContent(prompt, null, true);
                    setAiTips(prev => ({ ...prev, [spot.id]: tip }));
                } catch (error) {
                    if (error.message === 'NO_API_KEY') {
                        setAiTips(prev => ({ ...prev, [spot.id]: "æ‰¾ä¸åˆ° API Keyï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚" }));
                        setIsKeyModalOpen(true);
                    } else {
                        setAiTips(prev => ({ ...prev, [spot.id]: `é€£ç·šéŒ¯èª¤ (${error.message})ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Key` }));
                    }
                } finally {
                    setIsTipLoading(false);
                }
            };
            
            const handleOpenMap = () => {
                let points = [];
                
                const currentData = selectedDay === 'all' ? tripData : tripData.filter(day => day.dayId === selectedDay);
                currentData.forEach(day => {
                    day.spots.forEach(spot => {
                        let coord = spot.lat && spot.lon ? `${spot.lat},${spot.lon}` : null;
                        if (coord) {
                            if (points.length === 0 || points[points.length - 1] !== coord) {
                                points.push(coord);
                            }
                        }
                    });
                });
                
                if (points.length > 1 && points[0] !== points[points.length - 1]) {
                    points.push(points[0]);
                }
                
                if (points.length > 0) {
                    const url = `https://www.google.com/maps/dir/${points.join('/')}`;
                    window.open(url, '_blank');
                }
            };

            const openExpenseModal = (spot) => { 
                setCurrentEditingSpot(spot); 
                setExpenseForm({ category: 'food', amount: '', note: '' }); 
                setPendingReceipts([]);
                setQuotaStatus({ type: 'normal', text: 'API é¡åº¦æ­£å¸¸' });
                setIsModalOpen(true); 
            };

            const saveExpense = () => { 
                const newRecords = [];
                
                if (expenseForm.amount && !isNaN(expenseForm.amount)) {
                    newRecords.push({ 
                        id: Date.now(), 
                        category: expenseForm.category, 
                        amount: parseInt(expenseForm.amount), 
                        note: expenseForm.note 
                    });
                }

                pendingReceipts.forEach((p, idx) => {
                    if (p.isChecked && !p.isAnalyzing && p.amount > 0) {
                        newRecords.push({
                            id: Date.now() + idx + 1,
                            category: expenseForm.category,
                            amount: parseInt(p.amount),
                            note: p.note
                        });
                    }
                });

                if (newRecords.length === 0) return;
                
                const spotId = currentEditingSpot.id; 
                setExpenses(prev => ({ ...prev, [spotId]: [...(prev[spotId] || []), ...newRecords] })); 
                
                setIsModalOpen(false); 
            };

            const deleteExpense = (spotId, recordId) => { setExpenses(prev => ({ ...prev, [spotId]: prev[spotId].filter(r => r.id !== recordId) })); };
            
            const togglePendingReceipt = (id) => {
                setPendingReceipts(prev => prev.map(p => p.id === id ? { ...p, isChecked: !p.isChecked } : p));
            };

            const removePendingReceipt = (id) => {
                setPendingReceipts(prev => prev.filter(p => p.id !== id));
            };

            const handleImageUpload = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                const inputElement = e.target;

                const newItems = files.map(file => ({
                    id: Math.random().toString(36).substr(2, 9),
                    file,
                    amount: 0,
                    note: 'åˆ†æä¸­...',
                    isAnalyzing: true,
                    isChecked: true
                }));

                setPendingReceipts(prev => [...prev, ...newItems]);
                setIsAnalyzingReceipt(true);
                setQuotaStatus({ type: 'normal', text: 'é«˜é€Ÿåˆ†æä¸­ (Paid Key)' });

                await Promise.all(newItems.map(async (item) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = async () => {
                            const base64String = reader.result;
                            try {
                                const prompt = `Analyze this receipt image. Extract three things: 1. Total amount (number only). 2. Store name (max 10 chars, Traditional Chinese). 3. Date and Time in "YYYY/MM/DD HH:mm" format (e.g. 2026/01/30 14:30). If year is missing, guess current or nearby year. Return a clean JSON object with these exact keys: "amount", "store", "date". Do not include markdown.`;
                                
                                let responseText = await generateGeminiContent(prompt, base64String);
                                
                                let result;
                                const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                                if (jsonMatch) {
                                    result = JSON.parse(jsonMatch[0]);
                                } else {
                                    responseText = responseText.replace(/```json/g, '').replace(/```/g, '').trim();
                                    result = JSON.parse(responseText);
                                }
                                
                                if (result && (result.amount || result.amount === 0)) {
                                    const cleanAmount = String(result.amount).replace(/[^0-9.]/g, '');
                                    const autoNote = (result.date ? result.date + " " : "") + (result.store || "");
                                    
                                    setPendingReceipts(prev => prev.map(p => 
                                        p.id === item.id 
                                        ? { ...p, amount: cleanAmount, note: autoNote, isAnalyzing: false } 
                                        : p
                                    ));
                                } else {
                                     throw new Error("Invalid JSON");
                                }
                            } catch (error) {
                                let errorMsg = 'è¾¨è­˜å¤±æ•—';
                                if (error.message === 'NO_API_KEY') {
                                    errorMsg = 'è«‹è¨­å®š API Key';
                                    setQuotaStatus({ type: 'error', text: 'âŒ æœªè¨­å®š API é‡‘é‘°' });
                                    setIsKeyModalOpen(true);
                                }
                                setPendingReceipts(prev => prev.map(p => 
                                    p.id === item.id 
                                    ? { ...p, note: errorMsg, isAnalyzing: false, isChecked: false } 
                                    : p
                                ));
                            } finally {
                                resolve();
                            }
                        };
                        reader.readAsDataURL(item.file);
                    });
                }));

                setIsAnalyzingReceipt(false);
                setQuotaStatus({ type: 'normal', text: 'åˆ†æå®Œæˆ' });
                inputElement.value = '';
            };

            const handleOpenDailyDetail = (dayStats) => {
                setSelectedDailyStats(dayStats);
                setIsDailyDetailOpen(true);
            };

            const handleCalcPress = (val) => {
                if (val === 'AC') {
                    setCalcInput("");
                    setCalcResult("");
                } else if (val === 'DEL') {
                    setCalcInput(prev => prev.slice(0, -1));
                } else if (val === '=') {
                    try {
                        if (!calcInput) return;
                        let expression = calcInput.replace(/\^/g, '**');
                        const result = new Function('return ' + expression)();
                        if (!isFinite(result) || isNaN(result)) {
                            setCalcResult("Error");
                        } else {
                            const formatted = Math.round(result * 100000000) / 100000000;
                            setCalcResult(String(formatted));
                        }
                    } catch (e) {
                        setCalcResult("Error");
                    }
                } else {
                    setCalcInput(prev => prev + val);
                }
            };
            
            const handlePhotoGps = () => {
                setPhotoSearchStatus({ text: 'GPS å®šä½ä¸­...', type: 'loading' });
                
                if (!navigator.geolocation) {
                    setPhotoSearchStatus({ text: 'ç€è¦½å™¨ä¸æ”¯æ´ GPS', type: 'error' });
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        
                        if (mapInstanceRef.current) {
                            if (markerInstanceRef.current) mapInstanceRef.current.removeLayer(markerInstanceRef.current);
                            mapInstanceRef.current.setView([lat, lon], 15);
                            markerInstanceRef.current = L.marker([lat, lon]).addTo(mapInstanceRef.current);
                            mapInstanceRef.current.invalidateSize();
                        }

                        setPhotoSearchStatus({ text: 'è½‰æ›åœ°å€ä¸­...', type: 'loading' });

                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=14`)
                            .then(res => res.json())
                            .then(data => {
                                let place = data.address ? (data.address.city || data.address.town || data.address.district || "") : "";
                                if (place) {
                                    setPhotoSearchLocation(place);
                                    setPhotoSearchStatus({ text: `ğŸ“ å·²å®šä½ï¼š${place}`, type: 'success' });
                                } else {
                                    setPhotoSearchLocation("æˆ‘çš„ä½ç½®");
                                    setPhotoSearchStatus({ text: 'ç„¡æ³•è¾¨è­˜åœ°å', type: 'error' });
                                }
                            })
                            .catch(err => {
                                setPhotoSearchStatus({ text: 'ç¶²è·¯éŒ¯èª¤', type: 'error' });
                            });
                    },
                    (err) => {
                        setPhotoSearchStatus({ text: 'å®šä½å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™', type: 'error' });
                    },
                    { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
                );
            };

            const executePhotoSearch = () => {
                let locationVal = photoSearchLocation.trim();

                if (!locationVal) {
                    setPhotoSearchStatus({ text: 'è«‹è¼¸å…¥åœ°é»ï¼', type: 'error' });
                    return;
                }

                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationVal)}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data && data.length > 0 && mapInstanceRef.current) {
                            const lat = parseFloat(data[0].lat);
                            const lon = parseFloat(data[0].lon);
                            if (markerInstanceRef.current) mapInstanceRef.current.removeLayer(markerInstanceRef.current);
                            mapInstanceRef.current.setView([lat, lon], 13);
                            markerInstanceRef.current = L.marker([lat, lon]).addTo(mapInstanceRef.current);
                        }
                    });

                let finalQuery = locationVal;
                if (photoSearchPeople.length > 0) finalQuery += " " + photoSearchPeople.join(" ");

                const url = `https://photos.google.com/search/${encodeURIComponent(finalQuery)}`;
                
                setPhotoSearchStatus({ text: 'æ­£åœ¨é–‹å•Ÿç›¸ç°¿...', type: 'success' });
                setTimeout(() => { window.open(url, '_blank'); }, 500);
            };

            const togglePhotoPerson = (name) => {
                setPhotoSearchPeople(prev => 
                    prev.includes(name) ? prev.filter(p => p !== name) : [...prev, name]
                );
            };

            // --- Stats & Daily Stats Calculation (A) ---
            const stats = useMemo(() => { 
                let totalJpy = 0; 
                const currentExpenses = expenses || {};
                Object.values(currentExpenses).forEach(recs => {
                    if (Array.isArray(recs)) {
                        recs.forEach(r => totalJpy += (r.amount || 0));
                    }
                });

                if (tripData) {
                    tripData.forEach(day => {
                        if (day.spots) {
                            day.spots.forEach(spot => {
                                if (spot.ticket) {
                                    const counts = spotTicketCounts[spot.id] || { adult: 2, child: 2 }; 
                                    totalJpy += (spot.ticket.adult * counts.adult + spot.ticket.child * counts.child);
                                }
                            });
                        }
                    });
                }
                return { totalJpy }; 
            }, [expenses, tripData, spotTicketCounts]);

            const dailyStats = useMemo(() => {
                if (!tripData) return [];
                const currentExpenses = expenses || {};
                return tripData.map(day => {
                    let dayTotal = 0;
                    if (day.spots) {
                        day.spots.forEach(spot => {
                            const spotExpenses = currentExpenses[spot.id] || [];
                            if (Array.isArray(spotExpenses)) {
                                spotExpenses.forEach(e => dayTotal += (e.amount || 0));
                            }
                            if (spot.ticket) {
                                const counts = spotTicketCounts[spot.id] || { adult: 2, child: 2 };
                                dayTotal += (spot.ticket.adult * counts.adult + spot.ticket.child * counts.child);
                            }
                        });
                    }
                    return {
                        ...day,
                        totalJpy: dayTotal,
                        totalTwd: dayTotal * EXCHANGE_RATE
                    };
                });
            }, [expenses, tripData, spotTicketCounts]);

            // --- Email Handler (A) ---
            const handleSendEmail = async () => {
                if (!emailInput) { alert("è«‹è¼¸å…¥ä¿¡ç®±"); return; }
                
                setIsSendingEmail(true);
                localStorage.setItem('user_email', emailInput);

                try {
                    let tableRows = "";
                    let grandTotal = 0;

                    tripData.forEach(day => {
                        tableRows += `<tr style="background-color: #e2e8f0;"><td colspan="4" style="border: 1px solid #ddd; padding: 8px; font-weight: bold; color: #333;">${day.date} - ${day.title}</td></tr>`;
                        
                        day.spots.forEach(spot => {
                            const spotExpenses = expenses[spot.id] || [];
                            spotExpenses.forEach(record => {
                                tableRows += `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${day.date}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${spot.name} (${record.category})</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${record.note || '-'}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${record.amount}</td>
                                    </tr>
                                `;
                                grandTotal += (record.amount || 0);
                            });

                            if (spot.ticket) {
                                const counts = spotTicketCounts[spot.id] || { adult: 2, child: 2 };
                                const ticketCost = (spot.ticket.adult * counts.adult + spot.ticket.child * counts.child);
                                if (ticketCost > 0) {
                                    tableRows += `
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${day.date}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${spot.name} (é–€ç¥¨)</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">å…¨ç¥¨${counts.adult}, å„ªå¾…${counts.child}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${ticketCost}</td>
                                        </tr>
                                    `;
                                    grandTotal += ticketCost;
                                }
                            }
                        });
                    });

                    const htmlMessage = `
                        <h2 style="color: #333;">2025 è·¨å¹´è¦ªå­éŠ - èŠ±è²»æ˜ç´°</h2>
                        <table style="width:100%; border-collapse: collapse; font-family: sans-serif; border: 1px solid #ddd;">
                            <thead>
                                <tr style="background-color: #00FFFF; color: #000;">
                                    <th style="border: 1px solid #ddd; padding: 12px;">æ—¥æœŸ</th>
                                    <th style="border: 1px solid #ddd; padding: 12px;">åœ°é»/é …ç›®</th>
                                    <th style="border: 1px solid #ddd; padding: 12px;">å‚™è¨»</th>
                                    <th style="border: 1px solid #ddd; padding: 12px;">é‡‘é¡ (NT$)</th>
                                </tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                            <tfoot>
                                <tr style="background-color: #f8f9fa;">
                                    <td colspan="3" style="border: 1px solid #ddd; padding: 12px; text-align: right; font-weight: bold; color: #333;">ç¸½è¨ˆ</td>
                                    <td style="border: 1px solid #ddd; padding: 12px; font-weight: bold; color: #E63946;">NT$ ${grandTotal.toLocaleString()}</td>
                                </tr>
                            </tfoot>
                        </table>
                        <p style="font-size: 12px; color: #666; margin-top: 20px;">æœ¬ä¿¡ä»¶ç”±æ—…éŠè¦åŠƒ App è‡ªå‹•ç™¼é€ã€‚</p>
                    `;

                    const params = {
                        email: emailInput,
                        to_email: emailInput,
                        recipient: emailInput,
                        subject: `æ—…éŠèŠ±è²»å ±è¡¨_${new Date().toLocaleDateString()}`,
                        message: htmlMessage
                    };

                    await window.emailjs.send("service_5yh7x6g", "template_dlbyml8", params);
                    
                    alert("âœ… ç™¼é€æˆåŠŸï¼");
                    setIsEmailModalOpen(false);

                } catch (error) {
                    alert("âŒ ç™¼é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚\n" + JSON.stringify(error));
                } finally {
                    setIsSendingEmail(false);
                }
            };

            const handleOpenEmailClick = () => {
                const savedEmail = localStorage.getItem('user_email') || "yofarn@gmail.com";
                setEmailInput(savedEmail);
                setIsEmailModalOpen(true);
            };

            const filteredTripData = selectedDay === 'all' ? tripData : tripData.filter(day => day.dayId === selectedDay);

            return (
                <div className="min-h-screen pb-24">
                    {/* Header Nav */}
                    <nav className="sticky top-0 z-50 bg-[#000000]/80 backdrop-blur-md border-b border-slate-700 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-20">
                                <div className="flex items-center gap-3">
                                    <div className="bg-[#FFD700] p-2 rounded-2xl text-slate-900 shadow-lg -rotate-6 border border-white/20">
                                        <Icons.Plane size={24} strokeWidth={3} />
                                    </div>
                                    <div>
                                        <div className="font-extrabold text-2xl tracking-tight text-slate-100 flex items-center gap-2 neon-text">
                                            2025 è·¨å¹´ <Icons.Smile className="text-[#FFD700]" size={20}/>
                                        </div>
                                        <div className="text-xs font-bold text-[#00FFFF] tracking-widest uppercase bg-[#00FFFF]/10 px-2 py-0.5 rounded-full inline-block border border-[#00FFFF]/30">Family New Year Trip</div>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setIsKeyModalOpen(true)} className="md:hidden bg-slate-800 p-2 rounded-full text-slate-400 border border-slate-700"><Icons.Settings size={20} /></button>
                                    <div className="text-right hidden sm:block">
                                        <div className="text-[10px] font-bold text-slate-400 uppercase bg-slate-800 px-2 rounded-full border border-slate-700">Total</div>
                                        <div className="font-mono font-bold text-[#FF6B6B] text-lg">NT$ {stats.totalJpy.toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </nav>
                    
                    {/* New Countdown Section */}
                    <div className="max-w-5xl mx-auto p-4 md:p-8 pt-0">
                        <Countdown />
                    </div>

                    <main className="max-w-5xl mx-auto p-4 md:p-8 pt-0">
                        
                        {/* 1. è¡Œç¨‹ (åŸ A: itinerary) */}
                        {activeMainTab === 'itinerary' && (
                            <div className="animate-in fade-in slide-in-from-bottom-6 duration-700">
                                <div className="flex flex-wrap gap-3 mb-8 justify-center sticky top-24 z-40 py-2 bg-[#000000]/80 backdrop-blur rounded-2xl border border-slate-700/50">
                                    <button onClick={() => setSelectedDay('all')} className={`px-5 py-2 rounded-xl text-sm font-bold border transition-all shadow-sm ${selectedDay === 'all' ? 'bg-[#FFD700] text-slate-900 border-[#FFD700]' : 'bg-slate-800 text-slate-400 border-slate-700 hover:border-slate-500'}`}>å…¨éƒ¨</button>
                                    {tripData.map(day => (
                                        <button key={day.dayId} onClick={() => setSelectedDay(day.dayId)} className={`px-5 py-2 rounded-xl text-sm font-bold border transition-all shadow-sm ${selectedDay === day.dayId ? `${day.themeColor} text-slate-900 border-transparent` : 'bg-slate-800 text-slate-400 border-slate-700 hover:border-slate-500'}`}>
                                            {day.date.split(' ')[0]}
                                        </button>
                                    ))}
                                </div>

                                <div className="space-y-12">
                                    {filteredTripData.map((day) => (
                                        <div key={day.dayId} className="relative">
                                            <div className="flex items-center gap-4 mb-6">
                                                <div className={`${day.themeColor} w-16 h-16 rounded-2xl flex flex-col items-center justify-center text-slate-900 shadow-[0_0_15px_rgba(255,255,255,0.1)] border-2 border-slate-700 -rotate-2`}>
                                                    <span className="text-xs font-bold uppercase">Day</span>
                                                    <span className="text-2xl font-black leading-none">{day.dayId.replace('day','')}</span>
                                                </div>
                                                <div className="glass-panel px-6 py-2 rounded-r-2xl rounded-bl-2xl shadow-sm border border-slate-700 flex-1">
                                                    <div className="text-2xl font-black text-slate-200">{day.date}</div>
                                                    <div className="text-lg font-bold text-slate-400">{day.title}</div>
                                                </div>
                                            </div>
                                            <div className="space-y-8 pl-4 border-l-4 border-dotted border-slate-700 ml-8">
                                                {day.spots.map((spot, index) => {
                                                    const spotExpenses = expenses[spot.id] || [];
                                                    const spotTotal = spotExpenses.reduce((sum, r) => sum + (r.amount || 0), 0);
                                                    const isShowingTip = activeTipSpotId === spot.id;
                                                    const counts = getTicketCounts(spot.id);
                                                    const ticketTotal = spot.ticket ? (spot.ticket.adult * counts.adult + spot.ticket.child * counts.child) : 0;
                                                    const totalCostDisplay = spotTotal + ticketTotal;

                                                    return (
                                                        <div key={spot.id} className="relative group">
                                                            <div className="absolute -left-[29px] top-6 w-5 h-5 rounded-full bg-[#000000] border-4 border-[#FFD700] z-10 shadow-[0_0_10px_#FFD700]"></div>
                                                            <div className="glass-panel rounded-[2rem] p-6 md:p-8 shadow-lg border border-slate-700 transition-all hover:-translate-y-1 hover:border-slate-500 hover:shadow-[0_10px_30px_rgba(0,0,0,0.5)] bg-[#1e293b]">
                                                                <div className="flex flex-col md:flex-row justify-between items-start gap-4 mb-4">
                                                                    <div className="flex-1 w-full">
                                                                        <div className="flex items-center justify-between mb-3">
                                                                            <div className="relative group/time flex items-center gap-2 bg-[#334155] rounded-xl px-3 py-1 border border-slate-600 shadow-sm text-[#FFD700] transform -rotate-1 hover:scale-105 transition-all w-fit">
                                                                                {index === 0 ? (
                                                                                    <>
                                                                                        <span className="text-sm font-bold font-mono text-white shrink-0">æŠµé”</span>
                                                                                        <input 
                                                                                            type="time" 
                                                                                            value={dayStartTimes[day.dayId] || "09:00"}
                                                                                            onChange={(e) => handleDayStartTimeChange(day.dayId, e.target.value)}
                                                                                            className="bg-slate-800 text-white rounded px-2 py-0.5 outline-none font-bold text-sm font-mono border border-slate-600 focus:border-[#FFD700]" 
                                                                                        />
                                                                                    </>
                                                                                ) : (
                                                                                    <>
                                                                                        <span className="text-sm font-bold font-mono text-[#FFD700] shrink-0">æŠµé”</span>
                                                                                        <span className="text-lg font-bold font-mono text-[#FFD700]">{spot.time}</span>
                                                                                    </>
                                                                                )}
                                                                            </div>
                                                                            
                                                                            <button 
                                                                                onClick={() => handleDepartureToggle(spot.id)}
                                                                                className={`flex items-center gap-2 px-4 py-2 rounded-full font-bold text-xs transition-all shadow-md active:scale-95 ${
                                                                                    spot.isDeparted 
                                                                                    ? 'bg-[#00FFFF]/20 text-[#00FFFF] border border-[#00FFFF]' 
                                                                                    : 'bg-[#FFD700] text-slate-900 hover:bg-[#ffbf57]'
                                                                                }`}
                                                                            >
                                                                                {spot.isDeparted ? (
                                                                                    <>
                                                                                        <Icons.Check size={14} />
                                                                                        å·²å‹•èº« {spot.actualDepTime}
                                                                                    </>
                                                                                ) : (
                                                                                    <>
                                                                                        <Icons.Navigation2 size={14} />
                                                                                        ç¢ºèªå‹•èº«
                                                                                    </>
                                                                                )}
                                                                            </button>
                                                                        </div>

                                                                        <h3 className="text-2xl font-black text-slate-100 mb-2">{spot.name}</h3>
                                                                        <div className="flex items-center gap-4 text-sm font-bold text-slate-400 mb-4 bg-slate-800 w-fit px-3 py-1 rounded-lg border border-slate-700">
                                                                                <span className="flex items-center gap-1"><WeatherIcon type={spot.weather} /> {spot.temp}</span>
                                                                                <span className="w-1.5 h-1.5 rounded-full bg-slate-600"></span>
                                                                                <span className="flex items-center gap-1">
                                                                                    åœç•™ 
                                                                                    <select 
                                                                                        value={spot.stay} 
                                                                                        onChange={(e) => handleStayChangeNew(spot.id, e.target.value)}
                                                                                        className="bg-transparent outline-none cursor-pointer border-b border-dashed border-slate-500 hover:border-[#FFD700] hover:text-[#FFD700] transition-colors ml-1 appearance-none text-center"
                                                                                    >
                                                                                        {STAY_OPTIONS.map(opt => <option key={opt} value={opt} className="bg-slate-800 text-slate-200">{opt}</option>)}
                                                                                    </select>
                                                                                </span>
                                                                        </div>
                                                                        
                                                                        {spot.ticket && (
                                                                            <div className="mb-4 bg-[#0f172a] border border-slate-700 p-3 rounded-xl">
                                                                                <div className="flex flex-col gap-2">
                                                                                    <div className="flex items-center justify-between border-b border-slate-700 pb-2">
                                                                                        <div className="flex items-center gap-2 text-[#FFD700] font-bold">
                                                                                            <Icons.Ticket size={16} />
                                                                                            <span>é–€ç¥¨ä¼°ç®—</span>
                                                                                        </div>
                                                                                        <div className="font-mono font-bold text-lg text-[#FFD700]">
                                                                                            NT${ticketTotal.toLocaleString()}
                                                                                        </div>
                                                                                    </div>
                                                                                    
                                                                                    <div className="flex justify-between items-center text-xs text-slate-400">
                                                                                        <div className="flex items-center gap-2">
                                                                                            <span>å…¨ç¥¨ (NT${spot.ticket.adult})</span>
                                                                                            <div className="flex items-center gap-1 bg-slate-800 rounded-lg p-0.5 border border-slate-600">
                                                                                                <button onClick={() => updateSpotTicketCount(spot.id, 'adult', -1)} className="w-6 h-6 flex items-center justify-center hover:bg-slate-700 rounded text-slate-300 hover:text-white transition-colors">-</button>
                                                                                                <span className="font-mono w-4 text-center text-white font-bold">{counts.adult}</span>
                                                                                                <button onClick={() => updateSpotTicketCount(spot.id, 'adult', 1)} className="w-6 h-6 flex items-center justify-center hover:bg-slate-700 rounded text-slate-300 hover:text-white transition-colors">+</button>
                                                                                            </div>
                                                                                        </div>
                                                                                        <div className="flex items-center gap-2">
                                                                                            <span>å„ªå¾… (NT${spot.ticket.child})</span>
                                                                                            <div className="flex items-center gap-1 bg-slate-800 rounded-lg p-0.5 border border-slate-600">
                                                                                                <button onClick={() => updateSpotTicketCount(spot.id, 'child', -1)} className="w-6 h-6 flex items-center justify-center hover:bg-slate-700 rounded text-slate-300 hover:text-white transition-colors">-</button>
                                                                                                <span className="font-mono w-4 text-center text-white font-bold">{counts.child}</span>
                                                                                                <button onClick={() => updateSpotTicketCount(spot.id, 'child', 1)} className="w-6 h-6 flex items-center justify-center hover:bg-slate-700 rounded text-slate-300 hover:text-white transition-colors">+</button>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        )}

                                                                        <div className="text-lg font-bold text-slate-300 leading-relaxed mb-6 relative">
                                                                                <span className="text-4xl absolute -top-4 -left-2 text-slate-700 z-0">â€œ</span>
                                                                                <p className="relative z-10">{spot.desc}</p>
                                                                        </div>
                                                                        <div className="flex flex-wrap gap-2 mb-4">
                                                                                <div className="bg-slate-800 border border-slate-600 px-3 py-1.5 rounded-xl text-xs font-bold text-slate-400 flex items-center gap-1"><Icons.MapPin size={12} className="text-[#00FFFF]" /> {spot.mapcodeLabel}: <span className="font-mono text-slate-300">{spot.mapcodeDisplay}</span></div>
                                                                                <a href={spot.gmapLink} target="_blank" rel="noreferrer" className="bg-[#00FFFF] text-slate-900 hover:bg-[#4ECDC4] px-3 py-1.5 rounded-xl text-xs font-bold transition-colors flex items-center gap-1 shadow-[0_2px_10px_rgba(0,255,255,0.3)] active:translate-y-[1px] active:shadow-none">
                                                                                    æ‰“é–‹åœ°åœ– <Icons.ExternalLink size={10} />
                                                                                </a>
                                                                                <button 
                                                                                    onClick={() => handleGetSpotTip(spot, day.date)} 
                                                                                    className={`px-3 py-1.5 rounded-xl text-xs font-bold transition-all flex items-center gap-1 border ${isShowingTip ? 'bg-indigo-600 text-white border-indigo-600 shadow-[0_0_15px_rgba(139,92,246,0.5)]' : 'bg-slate-800 text-indigo-400 border-indigo-600 hover:bg-indigo-600/20'}`}
                                                                                >
                                                                                    <Icons.Sparkles size={12} /> {isShowingTip ? 'éš±è—å¯†æŠ€' : 'AI é˜²é›·'}
                                                                                </button>
                                                                        </div>

                                                                        {isShowingTip && (
                                                                            <div className="animate-in slide-in-from-top-2 duration-300">
                                                                                <div className="bg-indigo-900/50 border border-indigo-600/50 rounded-2xl p-4 relative mt-2 backdrop-blur-sm">
                                                                                    <div className="absolute -top-2.5 left-6 w-4 h-4 bg-indigo-900/50 border-t border-l border-indigo-600/50 transform rotate-45"></div>
                                                                                    <h4 className="font-black text-indigo-400 text-xs uppercase mb-2 flex items-center gap-1"><Icons.Sparkles size={12}/> AI é˜²é›·åŠ©ç†</h4>
                                                                                    {isTipLoading && !aiTips[spot.id] ? (
                                                                                        <div className="typing-indicator flex gap-1 items-center h-6">
                                                                                            <span className="w-1.5 h-1.5 bg-indigo-400 rounded-full"></span>
                                                                                            <span className="w-1.5 h-1.5 bg-indigo-400 rounded-full"></span>
                                                                                            <span className="w-1.5 h-1.5 bg-indigo-400 rounded-full"></span>
                                                                                        </div>
                                                                                    ) : (
                                                                                        <div 
                                                                                            className="text-sm font-bold text-slate-200 leading-relaxed markdown-content"
                                                                                            dangerouslySetInnerHTML={{ __html: marked.parse(aiTips[spot.id] || "") }}
                                                                                        />
                                                                                    )}
                                                                                </div>
                                                                            </div>
                                                                        )}

                                                                    </div>
                                                                    <button onClick={() => openExpenseModal(spot)} className="self-start md:self-center bg-[#FFD700] text-slate-900 p-4 rounded-2xl transition-all shadow-[0_4px_15px_rgba(255,215,0,0.3)] hover:-translate-y-1 hover:bg-[#ffbf57] active:translate-y-0 border border-white/10">
                                                                        <Icons.Wallet size={24} strokeWidth={2.5} />
                                                                    </button>
                                                                </div>
                                                                {(spotTotal > 0 || ticketTotal > 0) && (
                                                                    <div className="mt-4 pt-4 border-t border-dashed border-slate-700 flex justify-end items-center gap-2">
                                                                        <span className="text-xs font-bold text-slate-500 uppercase bg-slate-800 px-2 py-0.5 rounded border border-slate-700">Estimated Total</span>
                                                                        <span className="text-xl font-mono font-black text-[#FF6B6B]">NT${totalCostDisplay.toLocaleString()}</span>
                                                                    </div>
                                                                )}
                                                            </div>
                                                            {spot.nextStop && (
                                                                <div className="relative flex flex-col items-center my-6 gap-3">
                                                                    <div className="absolute top-0 bottom-0 w-0.5 bg-slate-700 -z-10"></div>
                                                                    
                                                                    <div className="bg-slate-800 border border-slate-600 px-4 py-2 rounded-2xl flex flex-col items-center gap-1 text-xs text-slate-400 shadow-lg z-10">
                                                                        <span className="font-bold text-slate-300">å‰å¾€ï¼š{spot.nextStop.name}</span>
                                                                        <div className="flex items-center gap-3">
                                                                            <span className="font-mono text-[#00FFFF]">{spot.nextStop.distance}</span>
                                                                            <span className="w-px h-3 bg-slate-600"></span>
                                                                            <button onClick={() => handleTransportToggle(spot.id)} className="flex items-center gap-1 hover:text-[#00FFFF] transition-colors font-bold">
                                                                                 {transportModes[spot.id] === 'walk' ? <><Icons.Footprints size={12} className="text-[#FFD700]"/> {spot.nextStop.walkTime}</> : <><Icons.Car size={12} className="text-[#00FFFF]"/> {spot.nextStop.driveTime}</>}</button>
                                                                        </div>
                                                                    </div>

                                                                    <a href={spot.nextStop.navLink} target="_blank" rel="noreferrer" className="bg-[#00FFFF] text-slate-900 px-4 py-2 rounded-full text-xs font-bold shadow-[0_0_15px_rgba(0,255,255,0.4)] hover:bg-[#4ECDC4] hover:scale-105 transition-all flex items-center gap-1 z-10 border border-white/10">
                                                                        <Icons.Navigation size={14} /> Google å°èˆª
                                                                    </a>
                                                                    
                                                                    <div className="text-slate-600 mt-1"><Icons.ArrowDown size={20} /></div>
                                                                    {spot.nextStop && (
                                                                       <div className="text-xs text-slate-500 mt-1">
                                                                          é è¨ˆæŠµé”ä¸‹ä¸€ç«™: <span className="text-[#00FFFF] font-bold font-mono">{spot.departureTime}</span> å¾Œ + {transportModes[spot.id] === 'walk' ? spot.nextStop.walkTime : spot.nextStop.driveTime}
                                                                       </div>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* 2. è³‡è¨Š (åŸ A: info) */}
                        {activeMainTab === 'info' && (
                            <div className="animate-in fade-in slide-in-from-bottom-6 duration-700 space-y-8">
                                <div className="glass-panel rounded-2xl border border-slate-700/50 shadow-2xl overflow-hidden">
                                    <div className="p-6 md:p-8 border-b border-slate-700/50 flex items-center gap-4">
                                        <div className="bg-[#00FFFF]/10 p-3 rounded-xl border border-[#00FFFF]/20 shadow-[0_0_15px_rgba(0,255,255,0.15)]">
                                            <Icons.Navigation size={28} className="text-[#00FFFF]" />
                                        </div>
                                        <div>
                                            <h1 className="text-2xl font-bold text-white tracking-wide">å¯¦ç”¨å°èˆª & å¿…è²·æ”»ç•¥</h1>
                                            <p className="text-slate-400 text-sm mt-1">ä¸€éµæœå°‹å‘¨é‚Šç”Ÿæ´»æ©Ÿèƒ½</p>
                                        </div>
                                    </div>
                                    <div className="p-6 md:p-8 bg-[#0a0a1e]/80">
                                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                                            {NAV_BUTTONS_NEW.map((btn, index) => (
                                                <button
                                                    key={index}
                                                    onClick={() => {
                                                        const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(btn.query)}`;
                                                        window.open(url, '_blank');
                                                    }}
                                                    className="group relative flex items-center p-4 rounded-xl bg-slate-800/50 border border-slate-700 hover:border-[#00FFFF]/50 hover:bg-slate-800 transition-all duration-300 text-left"
                                                >
                                                    <div className="flex-shrink-0 w-12 h-12 rounded-lg bg-slate-700/50 flex items-center justify-center text-slate-300 group-hover:text-[#00FFFF] group-hover:scale-110 group-hover:bg-slate-700 transition-all duration-300">
                                                        <btn.icon size={24} />
                                                    </div>
                                                    <div className="ml-4 flex-grow">
                                                        <h3 className="text-slate-200 font-medium group-hover:text-white transition-colors">
                                                            {btn.title}
                                                        </h3>
                                                        <p className="text-xs text-slate-500 mt-0.5 group-hover:text-[#00FFFF]/80 transition-colors flex items-center gap-1">
                                                            é–‹å•Ÿåœ°åœ– <Icons.MapPin size={10} />
                                                        </p>
                                                    </div>
                                                    <div className="opacity-0 group-hover:opacity-100 transition-opacity absolute right-3 top-3 text-slate-500">
                                                        <Icons.ExternalLink size={14} />
                                                    </div>
                                                </button>
                                            ))}
                                        </div>
                                        <div className="h-px bg-slate-700/50 w-full mb-8"></div>
                                        <div>
                                             <div className="flex justify-between items-center mb-6">
                                                <h4 className="text-sm font-bold text-slate-300 uppercase tracking-wider flex items-center gap-2">
                                                    <Icons.Gift size={16} className="text-[#FFD700]"/>
                                                    AI ä¼´æ‰‹ç¦®å¯†æŠ€
                                                </h4>
                                                {!userLocation && (
                                                    <select 
                                                        value={infoRegion} 
                                                        onChange={(e) => setInfoRegion(e.target.value)}
                                                        className="bg-slate-800 text-white text-xs py-2 px-4 rounded-xl border border-slate-600 outline-none focus:border-[#00FFFF] cursor-pointer"
                                                    >
                                                        {Object.entries(REGION_DATA).map(([key, data]) => (
                                                          <option key={key} value={key}>{data.label}</option>
                                                        ))}
                                                    </select>
                                                )}
                                                <button 
                                                  onClick={handleGetLocation}
                                                  disabled={isLocating}
                                                  className={`
                                                    ml-2 px-3 py-1.5 rounded-lg font-bold text-xs tracking-wide transition-all shadow-lg flex items-center gap-1
                                                    ${userLocation 
                                                      ? 'bg-[#00FFFF]/20 text-[#00FFFF] border border-[#00FFFF]' 
                                                      : 'bg-slate-700 text-slate-300 border border-slate-600 hover:bg-slate-600'
                                                    }
                                                  `}
                                                >
                                                  {isLocating ? <Icons.Loader2 className="animate-spin" size={12}/> : <Icons.LocateFixed size={12}/>}
                                                  {userLocation ? 'å·²å®šä½' : 'å®šä½'}
                                                </button>
                                            </div>
                                            
                                            <div className="bg-[#0a0a1e]/50 rounded-2xl p-6 border border-slate-700 relative overflow-hidden min-h-[160px]">
                                              {userLocation ? (
                                                  <>
                                                      <div className="text-lg font-bold mb-4 text-[#00FFFF] relative z-10 flex items-center gap-2">
                                                          ğŸ“ æ ¹æ“šæ‚¨ç›®å‰ä½ç½®çš„æ¨è–¦ï¼š
                                                      </div>
                                                      
                                                      {isAiSouvenirLoading ? (
                                                          <div className="flex flex-col items-center justify-center py-8 relative z-10">
                                                              <div className="typing-indicator flex gap-1 items-center h-6 mb-2">
                                                                  <span className="w-2 h-2 bg-[#00FFFF] rounded-full"></span>
                                                                  <span className="w-2 h-2 bg-[#00FFFF] rounded-full"></span>
                                                                  <span className="w-2 h-2 bg-[#00FFFF] rounded-full"></span>
                                                              </div>
                                                              <span className="text-xs text-slate-400">æ­£åœ¨åˆ†æç•¶åœ°åç”¢...</span>
                                                          </div>
                                                      ) : (
                                                          <>
                                                              <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 relative z-10">
                                                                {aiSouvenirs && aiSouvenirs.map((item, idx) => (
                                                                  <div key={idx} className="bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-[#00FFFF]/50 transition-colors group">
                                                                    <div className="text-slate-200 font-bold text-sm group-hover:text-[#00FFFF] transition-colors">{item.name}</div>
                                                                    <div className="text-slate-500 text-[10px] mt-1">{item.desc}</div>
                                                                  </div>
                                                                ))}
                                                              </div>
                                                              <a 
                                                                href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((aiSouvenirs?.map(s => s.name.split(' ')[0]).join(' OR ') || 'souvenirs') + ' near me')}`}
                                                                target="_blank"
                                                                rel="noreferrer"
                                                                className="block mt-6 text-center text-xs font-bold text-[#00FFFF] hover:text-white bg-slate-800/50 py-3 rounded-xl border border-[#00FFFF]/30 hover:bg-[#00FFFF] transition-all relative z-10"
                                                              >
                                                                <span className="flex items-center justify-center gap-2">
                                                                    <Icons.Search size={14}/> åœ¨åœ°åœ–ä¸Šæœå°‹é€™äº›æ¨è–¦
                                                                </span>
                                                              </a>
                                                          </>
                                                      )}
                                                      <div className="absolute -right-10 -bottom-10 w-40 h-40 rounded-full opacity-10 blur-2xl bg-[#00FFFF]"></div>
                                                  </>
                                              ) : (
                                                  <>
                                                      <div className={`text-lg font-bold mb-4 ${REGION_DATA[infoRegion].color} relative z-10`}>
                                                          ä½ åœ¨{REGION_DATA[infoRegion].label}å—ï¼Ÿå¿…è²·æ¨è–¦ï¼š
                                                      </div>
                                                      <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 relative z-10">
                                                        {REGION_DATA[infoRegion].souvenirs.map((item, idx) => (
                                                          <div key={idx} className="bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-[#FFD700]/50 transition-colors group">
                                                            <div className="text-slate-200 font-bold text-sm group-hover:text-[#FFD700] transition-colors">{item.name}</div>
                                                            <div className="text-slate-500 text-[10px] mt-1">{item.desc}</div>
                                                          </div>
                                                        ))}
                                                      </div>
                                                      <a 
                                                        href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(REGION_DATA[infoRegion].souvenirs.map(s => s.name.split(' ')[0]).join(' OR ') + ' near me')}`}
                                                        target="_blank"
                                                        rel="noreferrer"
                                                        className="block mt-6 text-center text-xs font-bold text-[#FFD700] hover:text-white bg-slate-800/50 py-3 rounded-xl border border-[#FFD700]/30 hover:bg-[#FFD700] transition-all relative z-10"
                                                      >
                                                        <span className="flex items-center justify-center gap-2">
                                                            <Icons.Search size={14}/> åœ¨åœ°åœ–ä¸Šæœå°‹é€™äº›ä¼´æ‰‹ç¦®
                                                        </span>
                                                      </a>
                                                      <div className={`absolute -right-10 -bottom-10 w-40 h-40 rounded-full opacity-10 blur-2xl ${REGION_DATA[infoRegion].color.replace('text-', 'bg-')}`}></div>
                                                  </>
                                              )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="glass-panel rounded-[2rem] p-8 shadow-lg border border-slate-700">
                                    <h3 className="text-2xl font-black text-slate-200 mb-6 flex items-center gap-2"><span className="bg-[#00FFFF] p-2 rounded-xl text-slate-900 rotate-3 shadow-lg"><Icons.Car size={20} /></span>è»Šç¨‹é ä¼°</h3>
                                    <div className="space-y-6">
                                        <div className="bg-[#00FFFF]/30 p-6 rounded-3xl border border-[#00FFFF]/50 relative overflow-hidden backdrop-blur-sm">
                                            <div className="flex justify-between items-center mb-4 relative z-10"><span className="bg-[#00FFFF] text-slate-900 text-xs font-black px-3 py-1 rounded-full shadow-md">å»ç¨‹</span><span className="font-bold text-slate-300">{FLIGHT_INFO_A.outbound.date}</span></div>
                                            <div className="flex justify-between items-center text-center relative z-10">
                                                <div><div className="text-4xl font-black text-slate-100">{FLIGHT_INFO_A.outbound.dep}</div><div className="text-sm font-bold text-slate-400">{FLIGHT_INFO_A.outbound.from}</div></div>
                                                <div className="flex-1 px-4 flex flex-col items-center"><div className="text-xs font-bold text-slate-500 mb-1">{FLIGHT_INFO_A.outbound.duration}</div><div className="w-full border-t border-dashed border-slate-600 relative my-2"><Icons.Car size={16} className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[#FFD700] bg-[#00FFFF]/20 px-1 rounded-full" /></div><div className="text-xs font-bold text-[#00FFFF] mt-1">{FLIGHT_INFO_A.outbound.flight}</div></div>
                                                <div><div className="text-4xl font-black text-slate-100">{FLIGHT_INFO_A.outbound.arr}</div><div className="text-sm font-bold text-slate-400">{FLIGHT_INFO_A.outbound.to}</div></div>
                                            </div>
                                        </div>
                                        <div className="bg-[#FFD700]/30 p-6 rounded-3xl border border-[#FFD700]/50 relative overflow-hidden backdrop-blur-sm">
                                            <div className="flex justify-between items-center mb-4 relative z-10"><span className="bg-[#FFD700] text-slate-900 text-xs font-black px-3 py-1 rounded-full shadow-md">å›ç¨‹</span><span className="font-bold text-slate-300">{FLIGHT_INFO_A.inbound.date}</span></div>
                                            <div className="flex justify-between items-center text-center relative z-10">
                                                <div><div className="text-4xl font-black text-slate-100">{FLIGHT_INFO_A.inbound.dep}</div><div className="text-sm font-bold text-slate-400">{FLIGHT_INFO_A.inbound.from}</div></div>
                                                <div className="flex-1 px-4 flex flex-col items-center"><div className="text-xs font-bold text-slate-500 mb-1">{FLIGHT_INFO_A.inbound.duration}</div><div className="w-full border-t border-dashed border-slate-600 relative my-2"><Icons.Car size={16} className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[#FFD700] bg-[#FFD700]/20 px-1 rounded-full" /></div><div className="text-xs font-bold text-[#FFD700] mt-1">{FLIGHT_INFO_A.inbound.flight}</div></div>
                                                <div><div className="text-4xl font-black text-slate-100">{FLIGHT_INFO_A.inbound.arr}</div><div className="text-sm font-bold text-slate-400">{FLIGHT_INFO_A.inbound.to}</div></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="glass-panel rounded-[2rem] p-8 shadow-lg border border-slate-700">
                                    <h3 className="text-2xl font-black text-slate-200 mb-6 flex items-center gap-2">
                                        <span className="bg-[#FFD700] p-2 rounded-xl text-slate-900 rotate-1 shadow-lg"><Icons.Car size={20} /></span>
                                        è¡Œè»Šæª¢æŸ¥æ¸…å–®
                                        <span className="text-xs bg-slate-700 text-slate-300 px-2 py-1 rounded ml-2">å‡ºç™¼å‰ç¢ºèª</span>
                                    </h3>
                                    <div className="bg-[#1e293b] p-6 rounded-2xl border border-slate-600 font-mono text-sm leading-relaxed text-slate-300">
                                        <ul className="space-y-2 list-disc list-inside">
                                            {RENTAL_INFO_LIST.map((item, idx) => (
                                                <li key={idx} className="break-words">
                                                    <span className="font-bold text-slate-200">{item.label}ï¼š</span>
                                                    {item.value}
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                </div>
                                <div className="glass-panel rounded-[2rem] p-8 shadow-lg border border-slate-700">
                                    <h3 className="text-2xl font-black text-slate-200 mb-6 flex items-center gap-2"><span className="bg-[#00FFFF] p-2 rounded-xl text-slate-900 -rotate-2 shadow-lg"><Icons.Hotel size={20} /></span>ä½å®¿å®‰æ’</h3>
                                    <div className="grid gap-4">
                                        {HOTEL_INFO_A.map((hotel, idx) => (
                                            <div key={idx} className="flex gap-4 p-4 rounded-2xl hover:bg-[#334155] transition-colors border border-slate-700 hover:border-[#FFD700]/50 group bg-[#1e293b]">
                                                <div className="bg-slate-700 text-white font-bold text-sm h-10 w-12 rounded-xl flex items-center justify-center shrink-0 shadow-md group-hover:bg-[#FFD700] transition-colors">{hotel.day}</div>
                                                <div className="flex-1"><h4 className="font-bold text-lg text-slate-200">{hotel.name}</h4><p className="text-sm font-bold text-slate-400 mt-1">{hotel.location} â€¢ {hotel.desc}</p></div>
                                                <a href={hotel.link} target="_blank" rel="noreferrer" className="self-center bg-slate-800 border border-slate-600 p-2 rounded-full text-slate-400 hover:text-[#FFD700] hover:border-[#FFD700] transition-colors"><Icons.Navigation size={20} /></a>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="glass-panel rounded-[2rem] p-6 shadow-lg border border-slate-700">
                                        <h3 className="text-lg font-black text-slate-200 mb-4">ç·Šæ€¥è¯çµ¡</h3>
                                        <div className="space-y-4">
                                            <a href="tel:119" className="flex items-center justify-between p-4 bg-red-900/50 rounded-2xl text-red-200 font-bold hover:bg-red-900 transition-colors border border-red-800"><span>ğŸš‘ æ•‘è­·è»Š/ç«è­¦</span><span className="text-2xl font-black">119</span></a>
                                            <a href="tel:110" className="flex items-center justify-between p-4 bg-blue-900/50 rounded-2xl text-blue-200 font-bold hover:bg-blue-900 transition-colors border border-blue-800"><span>ğŸš“ è­¦å¯Ÿå±€</span><span className="text-2xl font-black">110</span></a>
                                        </div>
                                    </div>
                                    <div className="glass-panel rounded-[2rem] p-6 shadow-lg border border-slate-700">
                                        <h3 className="text-lg font-black text-slate-200 mb-4">å¯¦ç”¨é€£çµ</h3>
                                        <div className="space-y-3">
                                            <a href="https://www.google.com/maps" target="_blank" rel="noreferrer" className="block w-full text-center py-3 bg-slate-700 border border-slate-600 text-slate-200 font-bold rounded-xl hover:bg-slate-600 active:bg-slate-500 transition-colors">Google Maps</a>
                                            <a href="https://www.cwa.gov.tw/V8/C/" target="_blank" rel="noreferrer" className="block w-full text-center py-3 bg-blue-900/40 border border-blue-800 text-blue-200 font-bold rounded-xl hover:bg-blue-900/60 active:bg-slate-500 transition-colors">ä¸­å¤®æ°£è±¡ç½²</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 3. çµ±è¨ˆ (åŸ A: stats) */}
                        {activeMainTab === 'stats' && (
                            <div className="animate-in fade-in slide-in-from-bottom-6 duration-700 space-y-8">
                                <div className="glass-panel rounded-[2rem] p-8 shadow-lg border border-slate-700">
                                    <h3 className="text-2xl font-black text-slate-200 mb-6 flex items-center gap-3">
                                        <span className="bg-[#FF6B6B] p-2 rounded-xl text-white rotate-2 shadow-lg">
                                            <Icons.Calculator size={20} />
                                        </span>
                                        å·¥ç¨‹è¨ˆç®—æ©Ÿ
                                    </h3>
                                    
                                    <div className="bg-[#0f172a] rounded-2xl p-4 mb-6 border border-slate-600 shadow-inner">
                                        <div className="text-right min-h-[1.5rem] text-sm text-slate-400 font-mono break-all tracking-wider">
                                            {calcInput || "0"}
                                        </div>
                                        <div className="text-right text-3xl font-bold font-mono text-[#FFD700] mt-1 break-all">
                                            {calcResult || (calcInput ? "=" : "")}
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-4 gap-3">
                                        <button onClick={() => handleCalcPress('AC')} className="bg-slate-700 text-red-300 font-bold p-4 rounded-xl hover:bg-slate-600 shadow-md">AC</button>
                                        <button onClick={() => handleCalcPress('(')} className="bg-slate-800 text-slate-300 font-bold p-4 rounded-xl hover:bg-slate-700 shadow-md">(</button>
                                        <button onClick={() => handleCalcPress(')')} className="bg-slate-800 text-slate-300 font-bold p-4 rounded-xl hover:bg-slate-700 shadow-md">)</button>
                                        <button onClick={() => handleCalcPress('DEL')} className="bg-slate-700 text-slate-300 font-bold p-4 rounded-xl hover:bg-slate-600 shadow-md">âŒ«</button>
                                        <button onClick={() => handleCalcPress('^')} className="bg-slate-800 text-[#00FFFF] font-bold p-4 rounded-xl hover:bg-slate-700 shadow-md text-lg">^</button>
                                        <button onClick={() => handleCalcPress('7')} className="bg-[#1e293b] text-white font-bold p-4 rounded-xl hover:bg-[#334155] shadow-md text-xl">7</button>
                                        <button onClick={() => handleCalcPress('8')} className="bg-[#1e293b] text-white font-bold p-4 rounded-xl hover:bg-[#334155] shadow-md text-xl">8</button>
                                        <button onClick={() => handleCalcPress('9')} className="bg-[#1e293b] text-white font-bold p-4 rounded-xl hover:bg-[#334155] shadow-md text-xl">9</button>
                                        <button onClick={() => handleCalcPress('/')} className="bg-slate-800 text-[#00FFFF] font-bold p-4 rounded-xl hover:bg-slate-700 shadow-md text-xl">Ã·</button>
                                        <button onClick={() => handleCalcPress('4')} className="bg-[#1e293b] text-white font-bold p-4 rounded-xl hover:bg-[#334155] shadow-md text-xl">4</button>
                                        <button onClick={() => handleCalcPress('5')} className="bg-[#1e293b] text-white font-bold p-4 rounded-xl hover:bg-[#334155] shadow-md text-xl">5</button>
                                        <button onClick={() => handleCalcPress('6')} className="bg-[#1e293b] text-white font-bold p-4 rounded-xl hover:bg-[#334155] shadow-md text-xl">6</button>
                                        <button onClick={() => handleCalcPress('*')} className="bg-slate-800 text-[#00FFFF] font-bold p-4 rounded-xl hover:bg-slate-700 shadow-md text-xl">Ã—</button>
                                        <button onClick={() => handleCalcPress('1')} className="bg-[#1e293b] text-white font-bold p-4 rounded-xl hover:bg-[#334155] shadow-md text-xl">1</button>
                                        <button onClick={() => handleCalcPress('2')} className="bg-[#1e293b] text-white font-bold p-4 rounded-xl hover:bg-[#334155] shadow-md text-xl">2</button>
                                        <button onClick={() => handleCalcPress('3')} className="bg-[#1e293b] text-white font-bold p-4 rounded-xl hover:bg-[#334155] shadow-md text-xl">3</button>
                                        <button onClick={() => handleCalcPress('-')} className="bg-slate-800 text-[#00FFFF] font-bold p-4 rounded-xl hover:bg-slate-700 shadow-md text-xl">-</button>
                                        <button onClick={() => handleCalcPress('0')} className="bg-[#1e293b] text-white font-bold p-4 rounded-xl hover:bg-[#334155] shadow-md text-xl">0</button>
                                        <button onClick={() => handleCalcPress('.')} className="bg-[#1e293b] text-white font-bold p-4 rounded-xl hover:bg-[#334155] shadow-md text-xl">.</button>
                                        <button onClick={() => handleCalcPress('+')} className="bg-slate-800 text-[#00FFFF] font-bold p-4 rounded-xl hover:bg-slate-700 shadow-md text-xl">+</button>
                                        <button onClick={() => handleCalcPress('=')} className="col-span-4 bg-[#FF6B6B] text-slate-900 font-bold p-4 rounded-xl hover:bg-[#ff5252] shadow-lg active:scale-[0.98] transition-transform text-xl">=</button>
                                    </div>
                                </div>

                                <div className="glass-panel rounded-[2rem] overflow-hidden shadow-lg border border-slate-700">
                                    <div className="bg-gradient-to-r from-blue-600 to-blue-500 p-4 text-center relative shadow-md">
                                        <h1 className="text-white text-lg font-bold flex items-center justify-center gap-2">
                                            <Icons.UsersViewfinder size={24} /> ç›¸ç°¿è¤‡åˆæœå°‹å™¨
                                        </h1>
                                        <p className="text-blue-100 text-xs mt-1 opacity-80">ä½ç½®èˆ‡äººç‰©å¿«é€Ÿæª¢ç´¢</p>
                                    </div>

                                    <div ref={mapContainerRef} className="h-48 w-full bg-[#0f172a] z-0"></div>

                                    <div className="p-6 space-y-6">
                                        <div className="space-y-2">
                                            <label className="text-xs font-bold text-slate-400 uppercase tracking-wide">Step 1: è¨­å®šåœ°é»</label>
                                            <div className="flex gap-2">
                                                <div className="relative flex-1">
                                                    <div className="absolute left-3 top-3 text-slate-400">
                                                        <Icons.MapLocation size={18} />
                                                    </div>
                                                    <input 
                                                        type="text" 
                                                        value={photoSearchLocation}
                                                        onChange={(e) => setPhotoSearchLocation(e.target.value)}
                                                        placeholder="ä¾‹å¦‚: ç¥æˆ¶å¸‚" 
                                                        className="w-full bg-[#1e293b] border border-slate-600 rounded-xl py-2.5 pl-10 pr-4 text-slate-200 focus:outline-none focus:border-blue-500 shadow-sm transition"
                                                    />
                                                </div>
                                                <button 
                                                    onClick={handlePhotoGps}
                                                    disabled={photoSearchStatus.type === 'loading'}
                                                    className="bg-slate-700 border border-slate-600 text-slate-200 px-3 rounded-xl hover:bg-slate-600 hover:text-white transition shadow-sm flex items-center justify-center" 
                                                    title="å®šä½ç›®å‰ä½ç½®"
                                                >
                                                    {photoSearchStatus.type === 'loading' ? <Icons.Loader2 className="animate-spin" size={20} /> : <Icons.LocateFixed size={20} />}
                                                </button>
                                            </div>
                                            <div className={`text-xs min-h-[1.5rem] flex items-center gap-1 ${photoSearchStatus.type === 'error' ? 'text-red-400 font-bold' : (photoSearchStatus.type === 'loading' ? 'text-blue-400' : 'text-slate-500')}`}>
                                                <Icons.Info size={14} /> {photoSearchStatus.text}
                                            </div>
                                        </div>

                                        <div className="border-t border-slate-700"></div>

                                        <div className="space-y-2">
                                            <label className="text-xs font-bold text-slate-400 uppercase tracking-wide">Step 2: åŒ…å«äººç‰© (å¯å¤šé¸)</label>
                                            <div className="grid grid-cols-2 gap-3">
                                                {FAMILY_MEMBERS.map(person => (
                                                    <label key={person} className="cursor-pointer relative group">
                                                        <input 
                                                            type="checkbox" 
                                                            checked={photoSearchPeople.includes(person)}
                                                            onChange={() => togglePhotoPerson(person)}
                                                            className="peer sr-only" 
                                                        />
                                                        <div className="border border-slate-600 bg-[#1e293b] rounded-xl p-3 flex items-center justify-between transition hover:bg-slate-700 peer-checked:bg-blue-900/30 peer-checked:border-blue-500 peer-checked:text-blue-400">
                                                            <span className="font-medium text-slate-300 peer-checked:text-blue-300">{person}</span>
                                                            <Icons.Check size={16} className="text-blue-500 opacity-0 peer-checked:opacity-100 transition-opacity" />
                                                        </div>
                                                    </label>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="pt-2">
                                            <button 
                                                onClick={executePhotoSearch} 
                                                className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3.5 rounded-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2 text-lg border border-blue-400/30"
                                            >
                                                <Icons.Search size={20} />
                                                <span>æœå°‹ç›¸ç°¿</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-4">
                                    <div className="flex items-center justify-between">
                                        <h3 className="text-xl font-black text-slate-200 ml-2 flex items-center gap-2"><Icons.Star className="text-[#FFD700]" fill="#FFD700" /> æ¯æ—¥èŠ±è²»</h3>
                                        <button 
                                            onClick={handleOpenEmailClick}
                                            className="text-xs font-bold text-slate-800 bg-[#00FFFF] px-3 py-1.5 rounded-full hover:bg-[#4ECDC4] transition-colors flex items-center gap-1 shadow-md"
                                        >
                                            <Icons.Mail size={14} /> ç™¼é€å ±è¡¨
                                        </button>
                                    </div>
                                    
                                    {dailyStats.map((day) => (
                                        <div 
                                            key={day.dayId} 
                                            onClick={() => handleOpenDailyDetail(day)}
                                            className="bg-[#1e293b] p-5 rounded-2xl shadow-md border border-slate-700 flex justify-between items-center transition-transform hover:-translate-y-1 hover:border-slate-500 cursor-pointer"
                                        >
                                            <div className="flex items-center gap-4"><div className={`${day.themeColor} px-3 py-1 rounded-lg text-xs font-black text-slate-900 shadow-sm`}>{day.date}</div><div className="font-bold text-slate-200">{day.title}</div></div>
                                            <div className="text-right"><div className="text-[10px] font-bold text-slate-500 uppercase">Total</div><div className="text-lg font-mono font-black text-[#FF6B6B]">NT$ {day.totalJpy.toLocaleString()}</div></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* 4. AI æƒé›· (åŸ B é é¢) */}
                        {activeMainTab === 'ai_guard' && (
                            <div className="animate-in fade-in slide-in-from-bottom-6 duration-700 space-y-8">
                                <header className="glass-panel p-6 rounded-2xl border border-blue-500/30">
                                    <h1 className="text-2xl font-black text-white flex items-center gap-2">
                                        <span className="bg-blue-600 p-2 rounded-lg"><Icons.Shield size={24}/></span> 
                                        AI æ—…éŠé˜²é›·åŠ©æ‰‹
                                    </h1>
                                    <p className="text-slate-400 text-sm mt-2">é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œåˆ©ç”¨ Gemini AI çµåˆ Google Search æŸ¥è­‰è³‡è¨Šã€‚</p>
                                </header>
                                
                                {/* èˆªç­æª¢æŸ¥ */}
                                <section className="glass-panel p-6 rounded-2xl border border-slate-700">
                                    <h3 className="font-bold text-white mb-4 flex items-center gap-2"><Icons.Plane className="text-blue-400"/> èˆªç­é˜²é›· (ç¯„ä¾‹: æ±äº¬è¡Œ)</h3>
                                    <div className="bg-slate-800 p-4 rounded-xl mb-4 border border-slate-600">
                                        <div className="flex justify-between text-sm text-slate-300 mb-2">
                                            <span>å»: {FLIGHT_INFO_B.outbound.flight} ({FLIGHT_INFO_B.outbound.airline})</span><span>{FLIGHT_INFO_B.outbound.date}</span>
                                        </div>
                                        <div className="flex justify-between text-sm text-slate-300">
                                            <span>å›: {FLIGHT_INFO_B.inbound.flight} ({FLIGHT_INFO_B.inbound.airline})</span><span>{FLIGHT_INFO_B.inbound.date}</span>
                                        </div>
                                    </div>
                                    {flightAnalysis && <div className="bg-blue-900/30 p-4 rounded-xl border border-blue-500/30 text-sm text-blue-200 mb-4"><ReactMarkdown>{flightAnalysis}</ReactMarkdown></div>}
                                    <button onClick={checkFlight} disabled={aiLoading} className="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-bold flex justify-center items-center gap-2 transition-colors">
                                        {aiLoading && !flightAnalysis ? <Icons.Loader2 className="animate-spin"/> : <Icons.Search size={16}/>} AI é©—è­‰èˆªç­
                                    </button>
                                </section>

                                {/* ä½å®¿æª¢æŸ¥ */}
                                <section className="glass-panel p-6 rounded-2xl border border-slate-700">
                                    <h3 className="font-bold text-white mb-4 flex items-center gap-2"><Icons.Hotel className="text-[#FFD700]"/> ä½å®¿é˜²é›· (ç¯„ä¾‹: æ±äº¬è¡Œ)</h3>
                                    <div className="space-y-4">
                                        {HOTEL_INFO_B.map((h,i) => (
                                            <div key={i} className="bg-slate-800 p-4 rounded-xl border border-slate-600">
                                                <div className="flex justify-between items-start mb-2">
                                                    <div>
                                                        <div className="font-bold text-slate-200 text-sm">{h.name}</div>
                                                        <div className="text-xs text-slate-400 mt-1">{h.location}</div>
                                                    </div>
                                                    <button onClick={()=>checkHotel(h.name)} disabled={aiLoading} className="text-xs bg-[#FFD700]/20 text-[#FFD700] px-3 py-1.5 rounded-lg border border-[#FFD700] hover:bg-[#FFD700] hover:text-slate-900 transition-colors flex items-center gap-1 font-bold shrink-0">
                                                        <Icons.Search size={12}/> æƒé›·
                                                    </button>
                                                </div>
                                                {hotelAnalysis[h.name] && <div className="text-sm text-slate-300 bg-black/20 p-3 rounded-lg mt-2 border border-white/5"><ReactMarkdown>{hotelAnalysis[h.name]}</ReactMarkdown></div>}
                                            </div>
                                        ))}
                                    </div>
                                </section>

                                {/* æ™¯é»æª¢æŸ¥ */}
                                <section className="space-y-4">
                                    <h3 className="text-xl font-bold text-white flex items-center gap-2 px-2">
                                        <Icons.Sparkles className="w-6 h-6 text-[#00FFFF]" />
                                        å†¬å­£ç²¾é¸æ™¯é» & AI æƒé›· (ç¯„ä¾‹: æ±äº¬è¡Œ)
                                    </h3>
                                    
                                    {AI_GUARD_DATA.map((dayGroup, idx) => (
                                        <div key={idx} className="space-y-3">
                                            <div className="sticky top-20 z-40 bg-[#000000]/95 backdrop-blur-sm py-2 px-4 border-b border-slate-700 text-sm font-bold text-[#FFD700] rounded-lg shadow-md">
                                                {dayGroup.date}
                                            </div>
                                            {dayGroup.spots.map((spot, sIdx) => {
                                                const resultKey = spot.name + `2026å¹´${dayGroup.date} ${spot.timeHint || ''}`.trim();
                                                return (
                                                    <div key={sIdx} className="glass-panel rounded-xl p-5 border-l-4 border-l-[#00FFFF] hover:border-l-blue-400 transition-all">
                                                        <div className="flex items-start gap-4">
                                                            <div className="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center text-2xl shrink-0">
                                                                <span className="text-2xl">{spot.icon}</span>
                                                            </div>
                                                            <div className="flex-1">
                                                                <div className="flex justify-between items-start">
                                                                    <h4 className="font-bold text-lg text-white mb-1">{spot.name}</h4>
                                                                    <a href={spot.url} target="_blank" className="text-slate-400 hover:text-white">
                                                                        <Icons.ExternalLink className="w-4 h-4" />
                                                                    </a>
                                                                </div>
                                                                <div className="flex flex-wrap gap-2 mb-3">
                                                                    <span className="text-xs bg-slate-700/50 text-slate-300 px-2 py-0.5 rounded flex items-center gap-1">
                                                                        <Icons.MapPin className="w-3 h-3" /> {spot.location}
                                                                    </span>
                                                                    <span className="text-xs bg-blue-900/30 text-blue-200 px-2 py-0.5 rounded border border-blue-500/20">
                                                                        {spot.tags[0]}
                                                                    </span>
                                                                </div>
                                                                
                                                                <div className="strategy-box p-3 rounded-r-lg text-sm text-slate-200 mb-3 relative group">
                                                                    <div className="font-bold text-[#00FFFF] text-xs mb-1 flex items-center gap-1">
                                                                        <Icons.Sun className="w-3 h-3" /> é”äººç­†è¨˜
                                                                    </div>
                                                                    {spot.strategy}
                                                                </div>

                                                                {spotAnalysis[resultKey] && (
                                                                    <div className="mb-3 p-3 bg-indigo-900/30 border border-indigo-500/30 rounded-lg text-sm text-indigo-100 animate-in fade-in">
                                                                        <div className="flex items-center gap-2 mb-2 text-indigo-300 font-bold border-b border-indigo-500/20 pb-1">
                                                                            <Icons.Bot className="w-4 h-4" /> AI æƒé›·å ±å‘Š
                                                                        </div>
                                                                        <ReactMarkdown>{spotAnalysis[resultKey]}</ReactMarkdown>
                                                                    </div>
                                                                )}

                                                                <button 
                                                                    onClick={() => checkSpot(spot, dayGroup.date)}
                                                                    disabled={aiLoading}
                                                                    className="w-full py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white rounded-lg text-sm font-medium transition-all shadow-lg shadow-indigo-500/20 flex items-center justify-center gap-2"
                                                                >
                                                                    {aiLoading ? <Icons.Loader2 className="animate-spin w-4 h-4"/> : <Icons.Check className="w-4 h-4"/>}
                                                                    AI é˜²é›·é©—è­‰ {spot.timeHint ? `(${spot.timeHint})` : ''}
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ))}
                                </section>

                                {/* é€šç”¨æª¢æŸ¥ */}
                                <section className="glass-panel p-6 rounded-2xl border border-slate-700">
                                    <h3 className="font-bold text-white mb-4 flex items-center gap-2"><Icons.Shield className="text-green-400"/> é€šç”¨æƒ…å ±åˆ†æ</h3>
                                    <textarea value={aiInput} onChange={e=>setAiInput(e.target.value)} placeholder="è²¼ä¸Šç¶²è·¯æ”»ç•¥æˆ–é¤å»³è©•è«–..." className="w-full h-32 bg-slate-800 rounded-xl p-3 text-sm text-white outline-none focus:ring-2 focus:ring-green-500 mb-3 border border-slate-600 resize-none"/>
                                    <button onClick={analyzeGeneral} disabled={aiLoading||!aiInput} className="w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded-lg font-bold transition-colors">é–‹å§‹åˆ†æ</button>
                                    {aiGeneralResult && <div className="mt-4 p-4 bg-slate-800 rounded-xl text-sm text-slate-300 border border-slate-600"><ReactMarkdown>{aiGeneralResult}</ReactMarkdown></div>}
                                </section>
                            </div>
                        )}
                    </main>

                    {/* Footer Nav - New 4-Tab version */}
                    <div className="fixed bottom-0 w-full bg-[#000000]/95 backdrop-blur-md border-t border-slate-700 pb-safe z-40 flex justify-around py-3 text-xs font-bold text-slate-500">
                        <button onClick={() => setActiveMainTab('itinerary')} className={`flex flex-col items-center gap-1 ${activeMainTab === 'itinerary' ? 'text-[#FFD700]' : 'hover:text-slate-300'}`}>
                            <Icons.List size={22} /> è¡Œç¨‹
                        </button>
                        <button onClick={() => setActiveMainTab('info')} className={`flex flex-col items-center gap-1 ${activeMainTab === 'info' ? 'text-[#00FFFF]' : 'hover:text-slate-300'}`}>
                            <Icons.LayoutGrid size={22} /> è³‡è¨Š
                        </button>
                        <button onClick={() => setActiveMainTab('stats')} className={`flex flex-col items-center gap-1 ${activeMainTab === 'stats' ? 'text-[#FF6B6B]' : 'hover:text-slate-300'}`}>
                            <Icons.Calculator size={22} /> çµ±è¨ˆ
                        </button>
                        <button onClick={() => setActiveMainTab('ai_guard')} className={`flex flex-col items-center gap-1 ${activeMainTab === 'ai_guard' ? 'text-indigo-400' : 'hover:text-slate-300'}`}>
                            <Icons.Shield size={22} /> AI æƒé›·
                        </button>
                    </div>

                    {/* Floating Buttons */}
                    <div className="fixed bottom-24 right-4 flex flex-col gap-3 z-50">
                        <button onClick={handleOpenMap} className="bg-slate-800 text-slate-300 p-3 rounded-full shadow-[0_4px_10px_rgba(0,0,0,0.5)] border border-slate-600 hover:bg-slate-700 hover:text-white transition-all">
                             <Icons.Map size={24} />
                        </button>
                        <button onClick={() => setIsKeyModalOpen(true)} className="bg-slate-800 text-slate-300 p-3 rounded-full shadow-[0_4px_10px_rgba(0,0,0,0.5)] border border-slate-600 hover:bg-slate-700 hover:text-white transition-all"><Icons.Settings size={24} /></button>
                    </div>

                    <ApiKeyModal isOpen={isKeyModalOpen} onClose={() => setIsKeyModalOpen(false)} />
                    
                    {/* Expense Modal (A) */}
                    {isModalOpen && currentEditingSpot && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[100] p-4 backdrop-blur-sm">
                            <div className="glass-panel rounded-2xl p-6 w-full max-w-sm bg-[#1e293b] border border-slate-600 flex flex-col max-h-[85vh]">
                                <h3 className="font-bold text-lg mb-4 text-slate-200 shrink-0">{currentEditingSpot.name}</h3>
                                
                                <div className="overflow-y-auto flex-1 pr-1 -mr-1">
                                    <input 
                                        type="text" 
                                        value={expenseForm.note} 
                                        onChange={e => setExpenseForm({...expenseForm, note: e.target.value})} 
                                        className="w-full bg-slate-800 p-3 rounded-xl mb-4 text-sm text-white border border-slate-600 outline-none focus:border-[#FFD700]" 
                                        placeholder="å‚™è¨»/æ‘˜è¦ (ä¾‹å¦‚: å•†åº—å)" 
                                    />

                                    <div className="relative mb-4">
                                        <input 
                                            type="number" 
                                            value={expenseForm.amount} 
                                            onChange={e => setExpenseForm({...expenseForm, amount: e.target.value})} 
                                            className="w-full bg-slate-800 p-3 rounded-xl text-xl font-mono text-white border border-slate-600 outline-none focus:border-[#FFD700] pr-32" 
                                            placeholder="é‡‘é¡" 
                                            autoFocus 
                                        />
                                        <div className="absolute right-12 top-1/2 -translate-y-1/2 flex items-center gap-2 z-10 pointer-events-none">
                                            <div className="relative pointer-events-auto">
                                                <input 
                                                    type="file" 
                                                    accept="image/*" 
                                                    id="gallery-upload" 
                                                    className="hidden"
                                                    multiple 
                                                    onChange={handleImageUpload}
                                                />
                                                <label htmlFor="gallery-upload" className={`p-1.5 rounded-lg cursor-pointer flex items-center justify-center transition-colors ${isAnalyzingReceipt ? 'text-slate-600 cursor-not-allowed' : 'text-slate-400 hover:text-white hover:bg-slate-700'}`}>
                                                    <Icons.Image size={20} />
                                                </label>
                                            </div>

                                            <div className="relative pointer-events-auto">
                                                <input 
                                                    type="file" 
                                                    accept="image/*" 
                                                    capture="environment" 
                                                    id="camera-upload" 
                                                    className="hidden" 
                                                    onChange={handleImageUpload}
                                                />
                                                <label htmlFor="camera-upload" className={`p-1.5 rounded-lg cursor-pointer flex items-center justify-center transition-colors ${isAnalyzingReceipt ? 'text-[#FFD700] animate-pulse' : 'text-slate-400 hover:text-white hover:bg-slate-700'}`}>
                                                    {isAnalyzingReceipt ? <Icons.Loader2 className="animate-spin" size={20} /> : <Icons.Camera size={20} />}
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    {pendingReceipts.length > 0 && (
                                        <div className="mb-4 space-y-2">
                                            <div className="flex justify-between items-center">
                                                <div className="text-xs font-bold text-[#00FFFF] flex items-center gap-1">
                                                    <Icons.Sparkles size={12}/> AI è¾¨è­˜çµæœ ({pendingReceipts.filter(p=>p.isChecked).length})
                                                </div>
                                                <div className={`text-[10px] font-bold px-2 py-0.5 rounded-full flex items-center gap-1 ${quotaStatus.type === 'error' ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}`}>
                                                    <div className={`w-1.5 h-1.5 rounded-full ${quotaStatus.type === 'error' ? 'bg-red-500 animate-pulse' : 'bg-green-500'}`}></div>
                                                    {quotaStatus.text}
                                                </div>
                                            </div>
                                            
                                            <div className="bg-slate-900/50 rounded-xl p-2 border border-[#00FFFF]/30 space-y-2 max-h-40 overflow-y-auto">
                                                {pendingReceipts.map(item => (
                                                    <div key={item.id} className={`flex items-center gap-3 p-2 rounded-lg transition-colors ${item.isChecked ? 'bg-[#00FFFF]/10' : 'opacity-50'}`}>
                                                        <input 
                                                            type="checkbox" 
                                                            checked={item.isChecked} 
                                                            onChange={() => togglePendingReceipt(item.id)}
                                                            className="w-4 h-4 rounded border-slate-500 accent-[#00FFFF] cursor-pointer shrink-0"
                                                        />
                                                        <div className="flex-1 min-w-0">
                                                            {item.isAnalyzing ? (
                                                                <div className="flex items-center gap-2 text-xs text-slate-400">
                                                                    <Icons.Loader2 size={12} className="animate-spin"/> {item.note}
                                                                </div>
                                                            ) : (
                                                                <>
                                                                    <div className={`font-bold text-sm truncate ${item.note.includes('é¡åº¦') || item.note.includes('å¤±æ•—') ? 'text-red-400' : 'text-slate-200'}`}>
                                                                        {item.note || 'æœªå‘½å'}
                                                                    </div>
                                                                    {item.amount > 0 && <div className="text-xs text-[#00FFFF] font-mono">NT${item.amount}</div>}
                                                                </>
                                                            )}
                                                        </div>
                                                        <button onClick={() => removePendingReceipt(item.id)} className="text-slate-500 hover:text-red-400 p-1">
                                                            <Icons.X size={14} />
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    <div className="pt-4 border-t border-dashed border-slate-700">
                                        <div className="text-xs font-bold text-slate-400 mb-3">æ­·å²ç´€éŒ„</div>
                                        <div className="space-y-2">
                                            {(expenses[currentEditingSpot.id] || []).map(record => {
                                                const dateMatch = record.note ? record.note.match(/^(\d{4}[-/]\d{2}[-/]\d{2}\s+\d{2}:\d{2})\s+(.*)$/) : null;
                                                
                                                return (
                                                    <div key={record.id} className="flex justify-between items-center text-sm bg-slate-800 p-3 rounded-xl border border-slate-600">
                                                        <div className="flex flex-col">
                                                            {dateMatch ? (
                                                                <>
                                                                    <span className="text-[10px] text-slate-500 block mb-0.5">{dateMatch[1]}</span>
                                                                    <span className="font-bold text-slate-200 text-base">{dateMatch[2]}</span>
                                                                </>
                                                            ) : (
                                                                <span className="font-bold text-slate-300">{record.note || "æ¶ˆè²»"}</span>
                                                            )}
                                                        </div>
                                                        <div className="flex items-center gap-3">
                                                            <span className="font-mono font-bold text-slate-100">NT${record.amount}</span>
                                                            <button onClick={() => deleteExpense(currentEditingSpot.id, record.id)} className="text-slate-400 hover:text-red-400"><Icons.X size={16} /></button>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-2 mt-4 shrink-0">
                                    <button onClick={() => setIsModalOpen(false)} className="flex-1 py-3 text-slate-400 hover:text-white">å–æ¶ˆ</button>
                                    <button onClick={saveExpense} className="flex-1 bg-[#FFD700] text-slate-900 rounded-xl font-bold shadow-[0_4px_0px_#d9aa5b] active:translate-y-[2px] active:shadow-none">
                                        {pendingReceipts.filter(p => p.isChecked).length > 0 ? `å„²å­˜ (${pendingReceipts.filter(p => p.isChecked).length + (expenseForm.amount ? 1 : 0)}ç­†)` : 'å„²å­˜'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Daily Detail Modal (A) */}
                    <DailyDetailModal 
                        isOpen={isDailyDetailOpen} 
                        onClose={() => setIsDailyDetailOpen(false)} 
                        dayData={selectedDailyStats} 
                        allExpenses={expenses}
                        spotTicketCounts={spotTicketCounts}
                    />

                    {/* Email Input Modal (A) */}
                    {isEmailModalOpen && (
                        <div className="fixed inset-0 bg-stone-900/80 backdrop-blur-sm flex items-center justify-center z-[130] p-4 animate-in fade-in duration-200">
                            <div className="glass-panel rounded-2xl p-6 w-full max-w-sm shadow-2xl bg-[#1e293b] border border-slate-700">
                                <h3 className="font-bold text-lg mb-2 text-slate-200 flex items-center gap-2">
                                    <Icons.Mail size={20} className="text-[#00FFFF]" /> å¯„é€èŠ±è²»å ±è¡¨
                                </h3>
                                <p className="text-xs text-slate-400 mb-4">å°‡æœ¬æ¬¡æ—…ç¨‹çš„æ‰€æœ‰èŠ±è²»æ˜ç´°è£½ä½œæˆè¡¨æ ¼ï¼Œå¯„é€åˆ°æ‚¨çš„ä¿¡ç®±ã€‚</p>
                                
                                <label className="block text-xs font-bold text-slate-300 mb-1">æ”¶ä»¶äººä¿¡ç®±</label>
                                <input 
                                    type="email" 
                                    value={emailInput}
                                    onChange={(e) => setEmailInput(e.target.value)}
                                    placeholder="your@email.com"
                                    className="w-full bg-slate-800 p-3 rounded-xl mb-6 text-sm text-white border border-slate-600 outline-none focus:border-[#00FFFF]"
                                />
                                
                                <div className="flex gap-2">
                                    <button 
                                        onClick={() => setIsEmailModalOpen(false)} 
                                        className="flex-1 py-2 text-slate-400 hover:text-white transition-colors"
                                        disabled={isSendingEmail}
                                    >
                                        å–æ¶ˆ
                                    </button>
                                    <button 
                                        onClick={handleSendEmail} 
                                        className="flex-1 bg-[#00FFFF] text-slate-900 rounded-xl font-bold py-2 shadow-lg hover:bg-[#4ECDC4] transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                        disabled={isSendingEmail}
                                    >
                                        {isSendingEmail ? <><Icons.Loader2 size={16} className="animate-spin" /> ç™¼é€ä¸­...</> : 'ç¢ºèªç™¼é€'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
